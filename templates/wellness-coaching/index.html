<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boedirep ‚Äî Wellness Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --sage: #4A7C59;
    --sage-light: #6B9E78;
    --sage-dim: #2D5C3A;
    --sage-faint: rgba(74,124,89,0.08);
    --sage-border: rgba(74,124,89,0.18);
    --cream: #FAF7F2;
    --cream2: #F2EDE4;
    --cream3: #E8E0D4;
    --brown: #5C4A32;
    --brown-light: #8B7355;
    --text: #1C1C1C;
    --text-dim: #6B6460;
    --text-faint: #9E9890;
    --white: #FFFFFF;
    --gold: #C4942A;
    --gold-light: #E8B84B;
    --red: #C0392B;
    --blue: #2D7D9A;
    --sidebar-w: 240px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    background: var(--cream);
    color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-weight: 400;
    display: flex;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--sage-dim);
    min-height: 100vh;
    position: fixed;
    left: 0; top: 0;
    display: flex;
    flex-direction: column;
    z-index: 50;
    transition: transform 0.3s;
  }
  .sidebar-brand {
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .brand-logo {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif;
    font-weight: 700; font-size: 1.1rem;
    color: white; margin-bottom: 0.75rem;
  }
  .brand-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem; font-weight: 700;
    color: white; letter-spacing: -0.01em;
  }
  .brand-tag {
    font-size: 0.7rem; color: rgba(255,255,255,0.5);
    letter-spacing: 0.05em; text-transform: uppercase;
    margin-top: 0.2rem;
  }
  .sidebar-nav { flex: 1; padding: 1.5rem 0; overflow-y: auto; }
  .nav-section { padding: 0 1rem; margin-bottom: 0.25rem; }
  .nav-section-label {
    font-size: 0.65rem; letter-spacing: 0.12em;
    text-transform: uppercase; color: rgba(255,255,255,0.35);
    padding: 0.75rem 0.5rem 0.4rem; font-weight: 600;
  }
  .nav-item {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.65rem 0.75rem; border-radius: 8px;
    color: rgba(255,255,255,0.65);
    font-size: 0.875rem; font-weight: 500;
    cursor: pointer; transition: all 0.2s;
    text-decoration: none; margin-bottom: 0.1rem;
    border: none; background: none; width: 100%;
    font-family: 'Plus Jakarta Sans', sans-serif;
  }
  .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
  .nav-item.active { background: rgba(255,255,255,0.15); color: white; }
  .nav-item.active .nav-icon { color: var(--gold-light); }
  .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }
  .nav-badge {
    margin-left: auto; background: var(--gold); color: white;
    font-size: 0.65rem; font-weight: 700;
    padding: 0.15rem 0.5rem; border-radius: 100px;
    min-width: 20px; text-align: center;
  }
  .sidebar-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  .user-card { display: flex; align-items: center; gap: 0.75rem; }
  .user-avatar {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem; font-weight: 700; color: white; flex-shrink: 0;
  }
  .user-name { font-size: 0.82rem; font-weight: 600; color: white; }
  .user-role { font-size: 0.7rem; color: rgba(255,255,255,0.45); }
  .conn-indicator {
    display: flex; align-items: center; gap: 0.4rem;
    margin-top: 0.6rem;
    font-size: 0.68rem; color: rgba(255,255,255,0.4);
  }
  .conn-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: rgba(255,255,255,0.25); flex-shrink: 0;
    transition: background 0.3s;
  }
  .conn-dot.connected { background: var(--gold-light); }

  /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
  .main { margin-left: var(--sidebar-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }

  /* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    background: var(--white); border-bottom: 1px solid var(--cream3);
    padding: 1rem 2rem;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 40;
  }
  .topbar-left h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.35rem; font-weight: 700; color: var(--text);
  }
  .topbar-left p { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.1rem; }
  .topbar-right { display: flex; align-items: center; gap: 1rem; }
  .topbar-btn {
    background: var(--sage-faint); border: 1px solid var(--sage-border);
    color: var(--sage); padding: 0.5rem 1.1rem; border-radius: 7px;
    font-size: 0.82rem; font-weight: 600; cursor: pointer;
    font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s;
  }
  .topbar-btn:hover { background: var(--sage); color: white; }
  .topbar-btn.primary { background: var(--sage); color: white; border-color: var(--sage); }
  .topbar-btn.primary:hover { background: var(--sage-dim); }
  .currency-toggle {
    display: flex; align-items: center; gap: 0.25rem;
    background: var(--cream2); border-radius: 7px; padding: 0.2rem;
    border: 1px solid var(--cream3);
  }
  .curr-btn {
    padding: 0.25rem 0.6rem; border-radius: 5px;
    font-size: 0.72rem; font-weight: 700; cursor: pointer; border: none;
    background: transparent; color: var(--text-faint);
    font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.15s;
  }
  .curr-btn.active { background: var(--white); color: var(--sage); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .hamburger {
    display: none; background: none; border: none; cursor: pointer;
    font-size: 1.4rem; color: var(--text); padding: 0.25rem;
  }

  /* ‚îÄ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ‚îÄ */
  .content { padding: 2rem; flex: 1; }

  /* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; animation: fadeUp 0.35s ease both; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 1.25rem; margin-bottom: 1.75rem;
  }
  .stat-card {
    background: var(--white); border: 1px solid var(--cream3);
    border-radius: 14px; padding: 1.5rem;
    position: relative; overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.07); }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .stat-card.green::before { background: linear-gradient(90deg, var(--sage), var(--sage-light)); }
  .stat-card.gold::before { background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
  .stat-card.brown::before { background: linear-gradient(90deg, var(--brown), var(--brown-light)); }
  .stat-card.red::before { background: var(--red); }
  .stat-label { font-size: 0.75rem; color: var(--text-faint); letter-spacing: 0.04em; text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; }
  .stat-value { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 0.4rem; }
  .stat-value .currency { font-size: 1rem; color: var(--text-dim); font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 500; }
  .stat-change { font-size: 0.78rem; display: flex; align-items: center; gap: 0.3rem; color: var(--text-dim); }
  .stat-change.up { color: var(--sage); }
  .stat-change.down { color: var(--red); }
  .stat-icon {
    position: absolute; top: 1.25rem; right: 1.25rem;
    width: 36px; height: 36px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
  }
  .stat-icon.green { background: var(--sage-faint); }
  .stat-icon.gold { background: rgba(196,148,42,0.08); }
  .stat-icon.brown { background: rgba(92,74,50,0.08); }
  .stat-icon.red { background: rgba(192,57,43,0.08); }

  /* ‚îÄ‚îÄ‚îÄ GRID LAYOUTS ‚îÄ‚îÄ‚îÄ */
  .grid-2 { display: grid; grid-template-columns: 1.6fr 1fr; gap: 1.25rem; margin-bottom: 1.75rem; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.25rem; margin-bottom: 1.75rem; }

  /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
  .card { background: var(--white); border: 1px solid var(--cream3); border-radius: 14px; overflow: hidden; margin-bottom: 1.25rem; }
  .card:last-child { margin-bottom: 0; }
  .card-header {
    padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--cream2);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; color: var(--text); }
  .card-subtitle { font-size: 0.75rem; color: var(--text-faint); margin-top: 0.1rem; }
  .card-action { font-size: 0.78rem; color: var(--sage); font-weight: 600; cursor: pointer; text-decoration: none; transition: opacity 0.2s; background: none; border: none; font-family: 'Plus Jakarta Sans', sans-serif; }
  .card-action:hover { opacity: 0.7; }
  .card-body { padding: 1.5rem; }

  /* ‚îÄ‚îÄ‚îÄ PROGRAMS ‚îÄ‚îÄ‚îÄ */
  .program-item {
    display: flex; align-items: center; padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--cream2); gap: 1rem;
    transition: background 0.15s; cursor: pointer;
  }
  .program-item:last-child { border-bottom: none; }
  .program-item:hover { background: var(--cream); }
  .program-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .program-dot.active { background: var(--sage); }
  .program-dot.upcoming { background: var(--gold); }
  .program-dot.full { background: var(--red); }
  .program-info { flex: 1; }
  .program-name { font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 0.2rem; }
  .program-meta { font-size: 0.75rem; color: var(--text-faint); display: flex; gap: 1rem; }
  .program-stats { text-align: right; flex-shrink: 0; }
  .program-enrolled { font-size: 0.875rem; font-weight: 700; color: var(--text); }
  .program-capacity { font-size: 0.72rem; color: var(--text-faint); }
  .program-revenue { font-size: 0.8rem; font-weight: 600; color: var(--sage); margin-top: 0.15rem; }
  .status-pill { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; padding: 0.2rem 0.6rem; border-radius: 100px; flex-shrink: 0; }
  .status-pill.active { background: rgba(74,124,89,0.1); color: var(--sage); }
  .status-pill.upcoming { background: rgba(196,148,42,0.1); color: var(--gold); }
  .status-pill.full { background: rgba(192,57,43,0.08); color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ SESSIONS ‚îÄ‚îÄ‚îÄ */
  .session-item { display: flex; align-items: center; padding: 0.9rem 1.5rem; border-bottom: 1px solid var(--cream2); gap: 1rem; }
  .session-item:last-child { border-bottom: none; }
  .session-time-box { width: 44px; flex-shrink: 0; text-align: center; }
  .session-time { font-size: 0.78rem; font-weight: 700; color: var(--sage); line-height: 1; }
  .session-period { font-size: 0.65rem; color: var(--text-faint); text-transform: uppercase; }
  .session-divider { width: 1px; height: 32px; background: var(--cream3); flex-shrink: 0; }
  .session-info { flex: 1; }
  .session-name { font-size: 0.85rem; font-weight: 600; color: var(--text); margin-bottom: 0.15rem; }
  .session-coach { font-size: 0.73rem; color: var(--text-faint); }
  .session-count { font-size: 0.78rem; color: var(--text-dim); font-weight: 500; flex-shrink: 0; }

  /* ‚îÄ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ */
  .chart-area {
    height: 160px; position: relative;
    display: flex; align-items: flex-end; gap: 0.5rem; padding: 0 0.5rem;
  }
  .chart-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.4rem; }
  .chart-bar {
    width: 100%; border-radius: 6px 6px 0 0;
    background: var(--sage-faint); border: 1px solid var(--sage-border);
    transition: background 0.2s; cursor: pointer; min-height: 4px;
  }
  .chart-bar.current { background: linear-gradient(180deg, var(--sage-light), var(--sage)); border-color: var(--sage); }
  .chart-bar:hover { background: var(--sage); border-color: var(--sage-dim); }
  .chart-bar.current:hover { background: var(--sage-dim); }
  .chart-label { font-size: 0.68rem; color: var(--text-faint); font-weight: 500; }

  /* ‚îÄ‚îÄ‚îÄ STAFF ‚îÄ‚îÄ‚îÄ */
  .staff-item { display: flex; align-items: center; gap: 0.9rem; padding: 0.9rem 1.5rem; border-bottom: 1px solid var(--cream2); }
  .staff-item:last-child { border-bottom: none; }
  .staff-avatar { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: white; flex-shrink: 0; }
  .staff-name { font-size: 0.875rem; font-weight: 600; color: var(--text); }
  .staff-role { font-size: 0.73rem; color: var(--text-faint); }
  .staff-sessions { margin-left: auto; text-align: right; }
  .staff-sessions-count { font-size: 0.85rem; font-weight: 700; color: var(--sage); }
  .staff-sessions-label { font-size: 0.68rem; color: var(--text-faint); }

  /* ‚îÄ‚îÄ‚îÄ TICKETS ‚îÄ‚îÄ‚îÄ */
  .ticket-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--cream2); cursor: pointer; transition: background 0.15s; }
  .ticket-item:last-child { border-bottom: none; }
  .ticket-item:hover { background: var(--cream); }
  .ticket-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.3rem; }
  .ticket-subject { font-size: 0.85rem; font-weight: 600; color: var(--text); }
  .ticket-id { font-size: 0.7rem; color: var(--text-faint); font-weight: 500; }
  .ticket-meta { font-size: 0.75rem; color: var(--text-faint); display: flex; gap: 1rem; align-items: center; }
  .priority-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .priority-dot.high { background: var(--red); }
  .priority-dot.medium { background: var(--gold); }
  .priority-dot.low { background: var(--sage); }

  /* ‚îÄ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ‚îÄ */
  .quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; padding: 1.5rem; }
  .quick-btn {
    background: var(--cream); border: 1px solid var(--cream3); border-radius: 10px;
    padding: 1rem; display: flex; flex-direction: column; align-items: flex-start;
    gap: 0.4rem; cursor: pointer; transition: all 0.2s; text-align: left;
    font-family: 'Plus Jakarta Sans', sans-serif;
  }
  .quick-btn:hover { border-color: var(--sage-border); background: var(--sage-faint); }
  .quick-btn-icon { font-size: 1.2rem; }
  .quick-btn-label { font-size: 0.8rem; font-weight: 600; color: var(--text); line-height: 1.2; }

  /* ‚îÄ‚îÄ‚îÄ CLIENT TABLE ‚îÄ‚îÄ‚îÄ */
  .client-table { width: 100%; border-collapse: collapse; }
  .client-table th {
    font-size: 0.7rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--text-faint); padding: 0.75rem 1.5rem; text-align: left;
    background: var(--cream); border-bottom: 1px solid var(--cream3);
  }
  .client-table td { padding: 0.9rem 1.5rem; font-size: 0.85rem; border-bottom: 1px solid var(--cream2); color: var(--text); }
  .client-table tr:last-child td { border-bottom: none; }
  .client-table tr:hover td { background: var(--cream); }
  .client-name { font-weight: 600; }
  .client-email { font-size: 0.75rem; color: var(--text-faint); margin-top: 0.1rem; }
  .client-avatar-sm { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.72rem; font-weight: 700; color: white; flex-shrink: 0; }
  .client-row-inner { display: flex; align-items: center; gap: 0.75rem; }
  .payment-pill { font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 100px; text-transform: uppercase; letter-spacing: 0.03em; }
  .payment-pill.paid { background: rgba(74,124,89,0.1); color: var(--sage); }
  .payment-pill.pending { background: rgba(196,148,42,0.1); color: var(--gold); }
  .payment-pill.overdue { background: rgba(192,57,43,0.08); color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ SECTION PAGES: TABLE+SEARCH ‚îÄ‚îÄ‚îÄ */
  .page-toolbar {
    display: flex; gap: 0.75rem; margin-bottom: 1.25rem; align-items: center;
  }
  .search-input {
    flex: 1; padding: 0.6rem 1rem;
    border: 1px solid var(--cream3); border-radius: 8px;
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.85rem;
    background: var(--white); outline: none; color: var(--text);
    transition: border-color 0.15s;
  }
  .search-input:focus { border-color: var(--sage-border); }
  .filter-select {
    padding: 0.6rem 1rem; border: 1px solid var(--cream3); border-radius: 8px;
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.85rem;
    background: var(--white); outline: none; cursor: pointer; color: var(--text);
  }

  /* ‚îÄ‚îÄ‚îÄ DATA TABLE ‚îÄ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th {
    font-size: 0.7rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase;
    color: var(--text-faint); padding: 0.75rem 1.25rem;
    text-align: left; background: var(--cream); border-bottom: 1px solid var(--cream3);
  }
  .data-table td { padding: 0.85rem 1.25rem; font-size: 0.85rem; border-bottom: 1px solid var(--cream2); color: var(--text); vertical-align: middle; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: var(--cream); }
  .table-wrap { overflow-x: auto; }

  /* ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ */
  .badge {
    display: inline-block; padding: 0.2rem 0.6rem; border-radius: 100px;
    font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
  }
  .badge-green { background: rgba(74,124,89,0.1); color: var(--sage); }
  .badge-gold { background: rgba(196,148,42,0.1); color: var(--gold); }
  .badge-red { background: rgba(192,57,43,0.08); color: var(--red); }
  .badge-blue { background: rgba(45,125,154,0.1); color: var(--blue); }
  .badge-gray { background: rgba(0,0,0,0.06); color: var(--text-faint); }
  .badge-brown { background: rgba(92,74,50,0.1); color: var(--brown); }

  /* ‚îÄ‚îÄ‚îÄ AVATAR ‚îÄ‚îÄ‚îÄ */
  .avatar-circle {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.72rem; font-weight: 700; color: white; flex-shrink: 0;
    background: linear-gradient(135deg, var(--sage), var(--sage-dim));
  }
  .cell-with-avatar { display: flex; align-items: center; gap: 0.65rem; }
  .cell-main { font-weight: 600; font-size: 0.85rem; color: var(--text); }
  .cell-sub { font-size: 0.72rem; color: var(--text-faint); margin-top: 0.1rem; }

  /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.45); z-index: 200;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--white); border-radius: 16px;
    width: 580px; max-width: 95vw; max-height: 90vh;
    overflow-y: auto; box-shadow: 0 24px 64px rgba(0,0,0,0.18);
  }
  .modal-header {
    padding: 1.5rem 1.75rem 1.25rem; border-bottom: 1px solid var(--cream3);
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; background: var(--white); z-index: 1;
  }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 1.15rem; font-weight: 700; }
  .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-faint); line-height: 1; padding: 0.1rem; }
  .modal-body { padding: 1.75rem; }
  .modal-footer { padding: 1.25rem 1.75rem; border-top: 1px solid var(--cream3); display: flex; gap: 0.75rem; justify-content: flex-end; }

  /* ‚îÄ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ‚îÄ */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
  .form-group.full { grid-column: 1 / -1; }
  .form-label { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); }
  .form-input {
    padding: 0.6rem 0.85rem; border: 1px solid var(--cream3); border-radius: 8px;
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.875rem;
    background: var(--cream); outline: none; color: var(--text);
    transition: border-color 0.15s, background 0.15s;
  }
  .form-input:focus { border-color: var(--sage-border); background: var(--white); }
  textarea.form-input { resize: vertical; min-height: 80px; }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  #toast {
    position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999;
    background: var(--text); color: white;
    padding: 0.75rem 1.25rem; border-radius: 10px; font-size: 0.85rem; font-weight: 500;
    transform: translateY(60px); opacity: 0; transition: all 0.3s; max-width: 320px;
  }
  #toast.show { transform: translateY(0); opacity: 1; }
  #toast.success { background: var(--sage-dim); }
  #toast.error { background: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ‚îÄ */
  .loading-row td { text-align: center; padding: 2.5rem; color: var(--text-faint); font-size: 0.875rem; }
  .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-faint); }
  .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
  .empty-state p { font-size: 0.875rem; }

  /* ‚îÄ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ‚îÄ */
  .pagination { display: flex; gap: 0.4rem; align-items: center; justify-content: flex-end; padding: 1rem 1.5rem; border-top: 1px solid var(--cream2); }
  .page-btn {
    padding: 0.3rem 0.7rem; border: 1px solid var(--cream3); border-radius: 6px;
    background: var(--white); cursor: pointer; font-size: 0.78rem;
    font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-dim); transition: all 0.15s;
  }
  .page-btn:hover { background: var(--cream2); }
  .page-btn.active { background: var(--sage); color: white; border-color: var(--sage); font-weight: 700; }
  .page-info { font-size: 0.75rem; color: var(--text-faint); margin: 0 0.5rem; }

  .notif-btn {
    width: 38px; height: 38px; border-radius: 9px;
    background: var(--cream2); border: 1px solid var(--cream3);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1rem; position: relative; flex-shrink: 0;
    user-select: none;
  }
  .notif-dot {
    position: absolute; top: 7px; right: 7px;
    width: 7px; height: 7px; background: var(--gold);
    border-radius: 50%; border: 1.5px solid white;
    display: none;
  }
  .notif-dot.show { display: block; }
  .notif-dropdown {
    display: none; position: absolute; top: calc(100% + 10px); right: 0;
    width: 300px; background: var(--white); border: 1px solid var(--cream3);
    border-radius: 12px; box-shadow: 0 12px 36px rgba(0,0,0,0.12);
    z-index: 200; overflow: hidden;
  }
  .notif-dropdown.open { display: block; }
  .notif-header {
    padding: 0.9rem 1.25rem; border-bottom: 1px solid var(--cream2);
    font-size: 0.82rem; font-weight: 700; color: var(--text);
  }
  .notif-item {
    padding: 0.85rem 1.25rem; border-bottom: 1px solid var(--cream2);
    cursor: pointer; transition: background 0.15s;
  }
  .notif-item:last-child { border-bottom: none; }
  .notif-item:hover { background: var(--cream); }
  .notif-item-title { font-size: 0.82rem; font-weight: 600; color: var(--text); margin-bottom: 0.2rem; }
  .notif-item-sub { font-size: 0.73rem; color: var(--text-faint); }

  /* ‚îÄ‚îÄ‚îÄ ROW ACTIONS ‚îÄ‚îÄ‚îÄ */
  .row-actions { display: flex; gap: 0.35rem; align-items: center; }
  .action-btn {
    padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.72rem;
    font-weight: 600; cursor: pointer; border: 1px solid transparent;
    font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.15s;
    white-space: nowrap;
  }
  .action-btn.view { background: var(--sage-faint); color: var(--sage); border-color: var(--sage-border); }
  .action-btn.view:hover { background: var(--sage); color: white; }
  .action-btn.edit { background: rgba(196,148,42,0.08); color: var(--gold); border-color: rgba(196,148,42,0.2); }
  .action-btn.edit:hover { background: var(--gold); color: white; }
  .action-btn.del { background: rgba(192,57,43,0.07); color: var(--red); border-color: rgba(192,57,43,0.15); }
  .action-btn.del:hover { background: var(--red); color: white; }
  .action-btn.convert { background: rgba(45,125,154,0.08); color: var(--blue); border-color: rgba(45,125,154,0.2); }
  .action-btn.convert:hover { background: var(--blue); color: white; }

  /* ‚îÄ‚îÄ‚îÄ VIEW/DETAIL MODAL ‚îÄ‚îÄ‚îÄ */
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
  .detail-item {
    padding: 0.75rem 0; border-bottom: 1px solid var(--cream2);
    display: flex; flex-direction: column; gap: 0.2rem;
  }
  .detail-item.full { grid-column: 1 / -1; }
  .detail-item:nth-last-child(-n+2) { border-bottom: none; }
  .detail-key { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-faint); }
  .detail-val { font-size: 0.875rem; color: var(--text); font-weight: 500; }
  .modal-wide { width: 700px; }

  /* ‚îÄ‚îÄ‚îÄ COMING SOON PAGES ‚îÄ‚îÄ‚îÄ */
  .coming-soon {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 5rem 2rem; text-align: center; color: var(--text-faint);
  }
  .coming-soon-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
  .coming-soon h3 { font-family: 'Playfair Display', serif; font-size: 1.35rem; color: var(--text-dim); margin-bottom: 0.5rem; }
  .coming-soon p { font-size: 0.875rem; max-width: 320px; line-height: 1.6; }
  @media (max-width: 1100px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main { margin-left: 0; }
    .hamburger { display: block; }
    .grid-2 { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: 1fr; }
    .content { padding: 1rem; }
    .topbar { padding: 1rem; }
    .form-grid { grid-template-columns: 1fr; }
    .currency-toggle { display: none; }
  }
  @media (max-width: 480px) {
    .stats-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <div class="brand-logo">B</div>
    <div class="brand-name">Boedirep</div>
    <div class="brand-tag">Wellness Coaching</div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-section-label">Overview</div>
      <button class="nav-item active" data-page="dashboard">
        <span class="nav-icon">‚¨°</span> Dashboard
      </button>
      <button class="nav-item" data-page="analytics">
        <span class="nav-icon">üìä</span> Analytics
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Programs</div>
      <button class="nav-item" data-page="programs">
        <span class="nav-icon">üåø</span> All Programs
      </button>
      <button class="nav-item" data-page="sessions">
        <span class="nav-icon">üìÖ</span> Sessions
      </button>
      <button class="nav-item" data-page="participants">
        <span class="nav-icon">üë•</span> Participants
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Business</div>
      <button class="nav-item" data-page="invoices">
        <span class="nav-icon">üí∞</span> Finance
      </button>
      <button class="nav-item" data-page="leads">
        <span class="nav-icon">üîÅ</span> CRM & Leads
      </button>
      <button class="nav-item" data-page="customers">
        <span class="nav-icon">üë§</span> Customers
      </button>
      <button class="nav-item" data-page="hr">
        <span class="nav-icon">üë§</span> HR & Staff
      </button>
      <button class="nav-item" data-page="support">
        <span class="nav-icon">üéß</span> Support
        <span class="nav-badge" id="ticketBadge" style="display:none">0</span>
      </button>
    </div>
  </nav>

  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar">AD</div>
      <div>
        <div class="user-name">Admin</div>
        <div class="user-role">Boedirep Admin</div>
      </div>
    </div>
    <div class="conn-indicator">
      <div class="conn-dot" id="connDot"></div>
      <span id="connStatus">Connecting‚Ä¶</span>
    </div>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main">

  <!-- TOPBAR -->
  <header class="topbar">
    <div style="display:flex;align-items:center;gap:1rem;">
      <button class="hamburger" id="hamburger">‚ò∞</button>
      <div class="topbar-left">
        <h1 id="pageHeading">Good morning, Boedirep üåø</h1>
        <p id="pageSubheading">Here's what's happening today</p>
      </div>
    </div>
    <div class="topbar-right" id="topbarRight">
      <!-- Dashboard-specific actions shown by default, others shown per page -->
      <div id="dashboardActions" style="display:flex;align-items:center;gap:0.75rem;">
        <div class="currency-toggle">
          <button class="curr-btn active" onclick="setCurr(this,'NGN')">NGN</button>
          <button class="curr-btn" onclick="setCurr(this,'USD')">USD</button>
        </div>
        <button class="topbar-btn" onclick="alert('New Program ‚Äî coming soon')">+ New Program</button>
        <button class="topbar-btn primary" onclick="openModal('modalInvoice')">+ Invoice</button>
        <div class="notif-btn" onclick="toggleNotifDropdown()">
          üîî
          <div class="notif-dot" id="notifDot"></div>
          <div class="notif-dropdown" id="notifDropdown">
            <div class="notif-header">Notifications</div>
            <div id="notifList"><div style="padding:1rem;text-align:center;color:var(--text-faint);font-size:0.82rem;">Loading‚Ä¶</div></div>
          </div>
        </div>
      </div>
      <div id="pageActions"></div>
    </div>
  </header>

  <div class="content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page active" id="page-dashboard">

      <div class="stats-row">
        <div class="stat-card green">
          <div class="stat-icon green">üåø</div>
          <div class="stat-label">Total Leads</div>
          <div class="stat-value" id="stat-leads">‚Äî</div>
          <div class="stat-change" id="stat-leads-sub">Loading‚Ä¶</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-icon gold">üí∞</div>
          <div class="stat-label">Open Invoices</div>
          <div class="stat-value" id="stat-invoices">‚Äî</div>
          <div class="stat-change down" id="stat-invoices-sub">Loading‚Ä¶</div>
        </div>
        <div class="stat-card brown">
          <div class="stat-icon brown">üë•</div>
          <div class="stat-label">Customers</div>
          <div class="stat-value" id="stat-customers">‚Äî</div>
          <div class="stat-change up" id="stat-customers-sub">Active clients</div>
        </div>
        <div class="stat-card red">
          <div class="stat-icon red">üéß</div>
          <div class="stat-label">Open Tickets</div>
          <div class="stat-value" id="stat-tickets">‚Äî</div>
          <div class="stat-change down" id="stat-tickets-sub">Loading‚Ä¶</div>
        </div>
      </div>

      <div class="grid-2">
        <!-- RECENT LEADS -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Recent Leads</div>
              <div class="card-subtitle">Latest inquiries from CRM</div>
            </div>
            <button class="card-action" onclick="navigate('leads')">View all ‚Üí</button>
          </div>
          <div id="dashLeads">
            <div class="loading-row"><table><tr><td>Loading‚Ä¶</td></tr></table></div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div style="display:flex;flex-direction:column;gap:1.25rem;">
          <!-- RECENT CUSTOMERS -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Recent Customers</div>
                <div class="card-subtitle">Latest active clients</div>
              </div>
              <button class="card-action" onclick="navigate('customers')">View all ‚Üí</button>
            </div>
            <div id="dashCustomers">
              <div style="padding:1.25rem;text-align:center;color:var(--text-faint);font-size:0.85rem;">Loading‚Ä¶</div>
            </div>
          </div>

          <!-- QUICK ACTIONS -->
          <div class="card">
            <div class="card-header"><div class="card-title">Quick Actions</div></div>
            <div class="quick-actions">
              <button class="quick-btn" onclick="openModal('modalLead')">
                <span class="quick-btn-icon">üîÅ</span>
                <span class="quick-btn-label">New Lead</span>
              </button>
              <button class="quick-btn" onclick="openModal('modalCustomer')">
                <span class="quick-btn-icon">‚ûï</span>
                <span class="quick-btn-label">New Customer</span>
              </button>
              <button class="quick-btn" onclick="openModal('modalInvoice')">
                <span class="quick-btn-icon">üì®</span>
                <span class="quick-btn-label">New Invoice</span>
              </button>
              <button class="quick-btn" onclick="navigate('support')">
                <span class="quick-btn-icon">üéß</span>
                <span class="quick-btn-label">View Tickets</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-3">
        <!-- REVENUE CHART -->
        <div class="card">
          <div class="card-header">
            <div><div class="card-title">Revenue</div><div class="card-subtitle">Last 8 months</div></div>
            <span style="font-size:0.75rem;color:var(--sage);font-weight:600;">2025‚Äì2026</span>
          </div>
          <div class="card-body">
            <div class="chart-area">
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:55px"></div><span class="chart-label">Jul</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:70px"></div><span class="chart-label">Aug</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:62px"></div><span class="chart-label">Sep</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:90px"></div><span class="chart-label">Oct</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:80px"></div><span class="chart-label">Nov</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:100px"></div><span class="chart-label">Dec</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar" style="height:110px"></div><span class="chart-label">Jan</span></div>
              <div class="chart-bar-wrap"><div class="chart-bar current" style="height:124px"></div><span class="chart-label" style="color:var(--sage);font-weight:700;">Feb</span></div>
            </div>
          </div>
        </div>

        <!-- STAFF -->
        <div class="card">
          <div class="card-header">
            <div><div class="card-title">Coaches & Staff</div><div class="card-subtitle">Active team</div></div>
            <button class="card-action" onclick="navigate('hr')">HR ‚Üí</button>
          </div>
          <div id="dashStaff">
            <div class="staff-item"><div class="staff-avatar" style="background:linear-gradient(135deg,#4A7C59,#2D5C3A)">AM</div><div><div class="staff-name">Amara Obi</div><div class="staff-role">Lead Nutritionist</div></div><div class="staff-sessions"><div class="staff-sessions-count">4</div><div class="staff-sessions-label">sessions/wk</div></div></div>
            <div class="staff-item"><div class="staff-avatar" style="background:linear-gradient(135deg,#C4942A,#8B6520)">TU</div><div><div class="staff-name">Tunde Adeyemi</div><div class="staff-role">Mind-Body Coach</div></div><div class="staff-sessions"><div class="staff-sessions-count">6</div><div class="staff-sessions-label">sessions/wk</div></div></div>
            <div class="staff-item"><div class="staff-avatar" style="background:linear-gradient(135deg,#5C4A32,#3D2E1A)">NG</div><div><div class="staff-name">Ngozi Eze</div><div class="staff-role">Wellness Coach</div></div><div class="staff-sessions"><div class="staff-sessions-count">5</div><div class="staff-sessions-label">sessions/wk</div></div></div>
          </div>
        </div>

        <!-- SUPPORT -->
        <div class="card">
          <div class="card-header">
            <div><div class="card-title">Support</div><div class="card-subtitle">Open client tickets</div></div>
            <button class="card-action" onclick="navigate('support')">View all ‚Üí</button>
          </div>
          <div id="dashTickets">
            <div style="padding:1.25rem;text-align:center;color:var(--text-faint);font-size:0.85rem;">Loading‚Ä¶</div>
          </div>
        </div>
      </div>

    </div><!-- /dashboard page -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEADS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-leads">
      <div class="page-toolbar">
        <input class="search-input" type="text" id="leadSearch" placeholder="Search by name, email, company‚Ä¶" oninput="filterLeads()">
        <select class="filter-select" id="leadStatusFilter" onchange="filterLeads()">
          <option value="">All Statuses</option>
          <option>Lead</option><option>Open</option><option>Replied</option>
          <option>Opportunity</option><option>Quotation</option><option>Interested</option>
          <option>Converted</option><option>Lost Quotation</option><option>Do Not Contact</option>
        </select>
        <select class="filter-select" id="leadQualFilter" onchange="filterLeads()">
          <option value="">All Qualification</option>
          <option>Unqualified</option><option>In Process</option><option>Qualified</option>
        </select>
        <button class="topbar-btn primary" onclick="openModal('modalLead')">+ New Lead</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Leads</div>
            <div class="card-subtitle" id="leadCountLabel">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th><th>Company</th><th>Contact</th>
                <th>Status</th><th>Qualification</th><th>Source</th><th>Owner</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="leadsBody">
              <tr class="loading-row"><td colspan="8">Loading leads‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="leadPagination"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CUSTOMERS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-customers">
      <div class="page-toolbar">
        <input class="search-input" type="text" id="customerSearch" placeholder="Search by name, group, territory‚Ä¶" oninput="filterCustomers()">
        <select class="filter-select" id="customerTypeFilter" onchange="filterCustomers()">
          <option value="">All Types</option>
          <option>Company</option><option>Individual</option><option>Partnership</option>
        </select>
        <select class="filter-select" id="customerGroupFilter" onchange="filterCustomers()">
          <option value="">All Groups</option>
        </select>
        <button class="topbar-btn primary" onclick="openModal('modalCustomer')">+ New Customer</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Customers</div>
            <div class="card-subtitle" id="customerCountLabel">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th><th>Type</th><th>Group</th><th>Territory</th>
                <th>Contact</th><th>Account Manager</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersBody">
              <tr class="loading-row"><td colspan="8">Loading customers‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="customerPagination"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVOICES PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-invoices">
      <div class="page-toolbar">
        <input class="search-input" type="text" id="invoiceSearch" placeholder="Search by customer or invoice #‚Ä¶" oninput="filterInvoices()">
        <select class="filter-select" id="invoiceStatusFilter" onchange="filterInvoices()">
          <option value="">All Statuses</option>
          <option>Draft</option><option>Submitted</option><option>Paid</option><option>Return</option><option>Overdue</option>
        </select>
        <button class="topbar-btn primary" onclick="openModal('modalInvoice')">+ New Invoice</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Sales Invoices</div>
            <div class="card-subtitle" id="invoiceCountLabel">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr><th>Invoice #</th><th>Customer</th><th>Date</th><th>Due Date</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="invoicesBody">
              <tr class="loading-row"><td colspan="7">Loading invoices‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="invoicePagination"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPPORT PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-support">
      <div class="page-toolbar">
        <input class="search-input" type="text" id="ticketSearch" placeholder="Search tickets‚Ä¶" oninput="filterTickets()">
        <select class="filter-select" id="ticketStatusFilter" onchange="filterTickets()">
          <option value="">All Statuses</option>
          <option>Open</option><option>Replied</option><option>Resolved</option><option>Closed</option>
        </select>
        <select class="filter-select" id="ticketPriorityFilter" onchange="filterTickets()">
          <option value="">All Priorities</option>
          <option>Low</option><option>Medium</option><option>High</option><option>Urgent</option>
        </select>
      </div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Support Tickets</div>
            <div class="card-subtitle" id="ticketCountLabel">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr><th>Ticket #</th><th>Subject</th><th>Customer</th><th>Status</th><th>Priority</th><th>Created</th></tr>
            </thead>
            <tbody id="ticketsBody">
              <tr class="loading-row"><td colspan="6">Loading tickets‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="ticketPagination"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HR PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-hr">
      <div class="page-toolbar">
        <input class="search-input" type="text" id="hrSearch" placeholder="Search employees‚Ä¶" oninput="filterHR()">
        <select class="filter-select" id="hrStatusFilter" onchange="filterHR()">
          <option value="">All Statuses</option>
          <option>Active</option><option>Inactive</option><option>Left</option>
        </select>
      </div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">HR & Staff</div>
            <div class="card-subtitle" id="hrCountLabel">Loading‚Ä¶</div>
          </div>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr><th>Employee</th><th>Designation</th><th>Department</th><th>Email</th><th>Status</th></tr>
            </thead>
            <tbody id="hrBody">
              <tr class="loading-row"><td colspan="5">Loading employees‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div id="hrPagination"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANALYTICS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-analytics">
      <div class="card"><div class="coming-soon">
        <div class="coming-soon-icon">üìä</div>
        <h3>Analytics</h3>
        <p>Program performance, revenue trends, and participant retention analytics ‚Äî coming soon.</p>
      </div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRAMS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-programs">
      <div class="card"><div class="coming-soon">
        <div class="coming-soon-icon">üåø</div>
        <h3>All Programs</h3>
        <p>Manage your wellness programs for diabetes patients ‚Äî cohorts, schedules, and capacity. Coming soon.</p>
      </div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSIONS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-sessions">
      <div class="card"><div class="coming-soon">
        <div class="coming-soon-icon">üìÖ</div>
        <h3>Sessions</h3>
        <p>Track individual coaching and group sessions, attendance, and session notes. Coming soon.</p>
      </div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARTICIPANTS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page" id="page-participants">
      <div class="card"><div class="coming-soon">
        <div class="coming-soon-icon">üë•</div>
        <h3>Participants</h3>
        <p>Enrolled members, health progress tracking, and program participation history. Coming soon.</p>
      </div></div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- NEW LEAD -->
<div class="modal-overlay" id="modalLead">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">New Lead</span>
      <button class="modal-close" onclick="closeModal('modalLead')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">First Name</label><input class="form-input" type="text" id="lf_first_name" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name</label><input class="form-input" type="text" id="lf_last_name" placeholder="Last name"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="lf_email_id" placeholder="email@example.com"></div>
        <div class="form-group"><label class="form-label">Mobile No</label><input class="form-input" type="tel" id="lf_mobile_no" placeholder="+62‚Ä¶"></div>
        <div class="form-group"><label class="form-label">WhatsApp</label><input class="form-input" type="tel" id="lf_whatsapp_no" placeholder="+62‚Ä¶"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-input" type="tel" id="lf_phone" placeholder="Office phone"></div>
        <div class="form-group"><label class="form-label">Organization</label><input class="form-input" type="text" id="lf_company_name" placeholder="Company name"></div>
        <div class="form-group"><label class="form-label">Job Title</label><input class="form-input" type="text" id="lf_job_title" placeholder="Position"></div>
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-input" id="lf_status">
            <option>Lead</option><option>Open</option><option>Replied</option>
            <option>Opportunity</option><option>Interested</option><option>Converted</option>
            <option>Lost Quotation</option><option>Do Not Contact</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Lead Type</label>
          <select class="form-input" id="lf_type">
            <option value="">‚Äî Select ‚Äî</option><option>Client</option><option>Channel Partner</option><option>Consultant</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Request Type</label>
          <select class="form-input" id="lf_request_type">
            <option value="">‚Äî Select ‚Äî</option><option>Product Enquiry</option><option>Request for Information</option><option>Suggestions</option><option>Other</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Qualification</label>
          <select class="form-input" id="lf_qualification_status">
            <option>Unqualified</option><option>In Process</option><option>Qualified</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">City</label><input class="form-input" type="text" id="lf_city" placeholder="City"></div>
        <div class="form-group"><label class="form-label">Country</label><input class="form-input" type="text" id="lf_country" placeholder="Country"></div>
        <div class="form-group"><label class="form-label">Website</label><input class="form-input" type="text" id="lf_website" placeholder="https://‚Ä¶"></div>
        <div class="form-group"><label class="form-label">No. of Employees</label>
          <select class="form-input" id="lf_no_of_employees">
            <option value="">‚Äî Select ‚Äî</option><option>1-10</option><option>11-50</option><option>51-200</option><option>201-500</option><option>501-1000</option><option>1000+</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalLead')">Cancel</button>
      <button class="topbar-btn primary" onclick="saveLead()">Save Lead</button>
    </div>
  </div>
</div>

<!-- NEW CUSTOMER -->
<div class="modal-overlay" id="modalCustomer">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">New Customer</span>
      <button class="modal-close" onclick="closeModal('modalCustomer')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Customer Name *</label><input class="form-input" type="text" id="cf_customer_name" placeholder="Full name or company name"></div>
        <div class="form-group"><label class="form-label">Customer Type *</label>
          <select class="form-input" id="cf_customer_type"><option>Company</option><option>Individual</option><option>Partnership</option></select>
        </div>
        <div class="form-group"><label class="form-label">Customer Group</label><input class="form-input" type="text" id="cf_customer_group" placeholder="e.g. Wellness Client"></div>
        <div class="form-group"><label class="form-label">Territory</label><input class="form-input" type="text" id="cf_territory" placeholder="e.g. Indonesia"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="cf_email" placeholder="email@example.com"></div>
        <div class="form-group"><label class="form-label">Mobile No</label><input class="form-input" type="tel" id="cf_mobile_no" placeholder="+62‚Ä¶"></div>
        <div class="form-group"><label class="form-label">Account Manager</label><input class="form-input" type="text" id="cf_account_manager" placeholder="User email"></div>
        <div class="form-group"><label class="form-label">Website</label><input class="form-input" type="text" id="cf_website" placeholder="https://‚Ä¶"></div>
        <div class="form-group"><label class="form-label">Industry</label><input class="form-input" type="text" id="cf_industry" placeholder="Industry type"></div>
        <div class="form-group"><label class="form-label">Market Segment</label><input class="form-input" type="text" id="cf_market_segment" placeholder="Segment"></div>
        <div class="form-group"><label class="form-label">Tax ID</label><input class="form-input" type="text" id="cf_tax_id" placeholder="NPWP / Tax number"></div>
        <div class="form-group"><label class="form-label">Billing Currency</label><input class="form-input" type="text" id="cf_default_currency" placeholder="IDR / USD"></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-input" id="cf_customer_details" placeholder="Additional notes about this customer‚Ä¶"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalCustomer')">Cancel</button>
      <button class="topbar-btn primary" onclick="saveCustomer()">Save Customer</button>
    </div>
  </div>
</div>

<!-- NEW INVOICE -->
<div class="modal-overlay" id="modalInvoice">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">New Sales Invoice</span>
      <button class="modal-close" onclick="closeModal('modalInvoice')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Customer *</label><input class="form-input" type="text" id="if_customer" placeholder="Customer name"></div>
        <div class="form-group"><label class="form-label">Posting Date</label><input class="form-input" type="date" id="if_posting_date"></div>
        <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" type="date" id="if_due_date"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalInvoice')">Cancel</button>
      <button class="topbar-btn primary" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- VIEW LEAD MODAL -->
<div class="modal-overlay" id="modalViewLead">
  <div class="modal modal-wide">
    <div class="modal-header">
      <span class="modal-title" id="viewLeadTitle">Lead Details</span>
      <button class="modal-close" onclick="closeModal('modalViewLead')">√ó</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding-bottom:1.25rem;border-bottom:1px solid var(--cream3);">
        <div class="avatar-circle" style="width:52px;height:52px;font-size:1.2rem;" id="viewLeadAvatar">?</div>
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;" id="viewLeadName">‚Äî</div>
          <div style="font-size:0.82rem;color:var(--text-faint);margin-top:0.2rem;" id="viewLeadJob">‚Äî</div>
          <div style="margin-top:0.4rem;" id="viewLeadStatusBadge"></div>
        </div>
      </div>
      <div class="detail-grid" id="viewLeadDetails"></div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalViewLead')">Close</button>
      <button class="topbar-btn" style="background:rgba(196,148,42,0.1);color:var(--gold);border-color:rgba(196,148,42,0.3);" onclick="openEditLeadFromView()">‚úèÔ∏è Edit</button>
    </div>
  </div>
</div>

<!-- EDIT LEAD MODAL -->
<div class="modal-overlay" id="modalEditLead">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Edit Lead</span>
      <button class="modal-close" onclick="closeModal('modalEditLead')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="el_name">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">First Name</label><input class="form-input" type="text" id="el_first_name"></div>
        <div class="form-group"><label class="form-label">Last Name</label><input class="form-input" type="text" id="el_last_name"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="el_email_id"></div>
        <div class="form-group"><label class="form-label">Mobile No</label><input class="form-input" type="tel" id="el_mobile_no"></div>
        <div class="form-group"><label class="form-label">WhatsApp</label><input class="form-input" type="tel" id="el_whatsapp_no"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-input" type="tel" id="el_phone"></div>
        <div class="form-group"><label class="form-label">Organization</label><input class="form-input" type="text" id="el_company_name"></div>
        <div class="form-group"><label class="form-label">Job Title</label><input class="form-input" type="text" id="el_job_title"></div>
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-input" id="el_status">
            <option>Lead</option><option>Open</option><option>Replied</option>
            <option>Opportunity</option><option>Interested</option><option>Converted</option>
            <option>Lost Quotation</option><option>Do Not Contact</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Lead Type</label>
          <select class="form-input" id="el_type">
            <option value="">‚Äî Select ‚Äî</option><option>Client</option><option>Channel Partner</option><option>Consultant</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Qualification</label>
          <select class="form-input" id="el_qualification_status">
            <option>Unqualified</option><option>In Process</option><option>Qualified</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">City</label><input class="form-input" type="text" id="el_city"></div>
        <div class="form-group"><label class="form-label">Country</label><input class="form-input" type="text" id="el_country"></div>
        <div class="form-group"><label class="form-label">Website</label><input class="form-input" type="text" id="el_website"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalEditLead')">Cancel</button>
      <button class="topbar-btn primary" onclick="updateLead()">Save Changes</button>
    </div>
  </div>
</div>

<!-- VIEW CUSTOMER MODAL -->
<div class="modal-overlay" id="modalViewCustomer">
  <div class="modal modal-wide">
    <div class="modal-header">
      <span class="modal-title">Customer Details</span>
      <button class="modal-close" onclick="closeModal('modalViewCustomer')">√ó</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding-bottom:1.25rem;border-bottom:1px solid var(--cream3);">
        <div class="avatar-circle" style="width:52px;height:52px;font-size:1.2rem;background:linear-gradient(135deg,#2D7D9A,#1A5269);" id="viewCustAvatar">?</div>
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;" id="viewCustName">‚Äî</div>
          <div style="font-size:0.82rem;color:var(--text-faint);margin-top:0.2rem;" id="viewCustGroup">‚Äî</div>
          <div style="margin-top:0.4rem;" id="viewCustTypeBadge"></div>
        </div>
      </div>
      <div class="detail-grid" id="viewCustDetails"></div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalViewCustomer')">Close</button>
      <button class="topbar-btn" style="background:rgba(196,148,42,0.1);color:var(--gold);border-color:rgba(196,148,42,0.3);" onclick="openEditCustFromView()">‚úèÔ∏è Edit</button>
    </div>
  </div>
</div>

<!-- EDIT CUSTOMER MODAL -->
<div class="modal-overlay" id="modalEditCustomer">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Edit Customer</span>
      <button class="modal-close" onclick="closeModal('modalEditCustomer')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ec_name">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Customer Name *</label><input class="form-input" type="text" id="ec_customer_name"></div>
        <div class="form-group"><label class="form-label">Customer Type</label>
          <select class="form-input" id="ec_customer_type"><option>Company</option><option>Individual</option><option>Partnership</option></select>
        </div>
        <div class="form-group"><label class="form-label">Customer Group</label><input class="form-input" type="text" id="ec_customer_group"></div>
        <div class="form-group"><label class="form-label">Territory</label><input class="form-input" type="text" id="ec_territory"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="ec_email_id"></div>
        <div class="form-group"><label class="form-label">Mobile No</label><input class="form-input" type="tel" id="ec_mobile_no"></div>
        <div class="form-group"><label class="form-label">Account Manager</label><input class="form-input" type="text" id="ec_account_manager"></div>
        <div class="form-group"><label class="form-label">Website</label><input class="form-input" type="text" id="ec_website"></div>
        <div class="form-group"><label class="form-label">Industry</label><input class="form-input" type="text" id="ec_industry"></div>
        <div class="form-group"><label class="form-label">Market Segment</label><input class="form-input" type="text" id="ec_market_segment"></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-input" id="ec_customer_details"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalEditCustomer')">Cancel</button>
      <button class="topbar-btn primary" onclick="updateCustomer()">Save Changes</button>
    </div>
  </div>
</div>

<!-- VIEW INVOICE MODAL -->
<div class="modal-overlay" id="modalViewInvoice">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="viewInvTitle">Invoice</span>
      <button class="modal-close" onclick="closeModal('modalViewInvoice')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="viewInvDetails"></div>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalViewInvoice')">Close</button>
      <button class="topbar-btn" style="background:var(--sage-faint);color:var(--sage);border-color:var(--sage-border);" id="viewInvFrappeLink" onclick="">‚Üó Open in Frappe</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div class="modal-overlay" id="modalConfirmDelete">
  <div class="modal" style="width:420px;">
    <div class="modal-header">
      <span class="modal-title">Confirm Delete</span>
      <button class="modal-close" onclick="closeModal('modalConfirmDelete')">√ó</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.9rem;color:var(--text-dim);line-height:1.6;" id="deleteConfirmMsg">Are you sure you want to delete this record? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="topbar-btn" onclick="closeModal('modalConfirmDelete')">Cancel</button>
      <button class="topbar-btn" style="background:var(--red);color:white;border-color:var(--red);" id="deleteConfirmBtn">Delete</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SITE       = 'https://boedirep.jh.frappe.cloud';
const API_KEY    = '8efad55bcd23082';
const API_SECRET = '809abef2d2111d0';
const HEADERS    = {
  'Authorization': `token ${API_KEY}:${API_SECRET}`,
  'Content-Type': 'application/json'
};
const PER_PAGE = 20;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  leads:     { all: [], filtered: [], page: 1 },
  customers: { all: [], filtered: [], page: 1 },
  invoices:  { all: [], filtered: [], page: 1 },
  tickets:   { all: [], filtered: [], page: 1 },
  hr:        { all: [], filtered: [], page: 1 },
};
const loaded = new Set();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiGet(endpoint) {
  try {
    const r = await fetch(`${SITE}${endpoint}`, { headers: HEADERS });
    if (!r.ok) throw new Error(r.status);
    const d = await r.json();
    return d.data ?? d.message ?? d;
  } catch(e) {
    console.warn('GET error:', e);
    return null;
  }
}

async function apiPost(endpoint, body) {
  const r = await fetch(`${SITE}${endpoint}`, {
    method: 'POST', headers: HEADERS, body: JSON.stringify(body)
  });
  const d = await r.json();
  if (!r.ok) throw new Error(d.exception || d.message || r.status);
  return d.data ?? d.message ?? d;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONNECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkConnection() {
  const result = await apiGet('/api/method/frappe.auth.get_logged_user');
  const dot    = document.getElementById('connDot');
  const label  = document.getElementById('connStatus');
  const ok     = !!result;
  dot.className   = 'conn-dot' + (ok ? ' connected' : '');
  label.textContent = ok ? 'Connected' : 'Offline mode';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PAGE_TITLES = {
  dashboard:    ['Good morning, Boedirep üåø', 'Here\'s what\'s happening today'],
  analytics:    ['Analytics', 'Program performance and revenue trends'],
  programs:     ['All Programs', 'Active and upcoming wellness cohorts'],
  sessions:     ['Sessions', 'Coaching and group session schedule'],
  participants: ['Participants', 'Enrolled members and progress tracking'],
  leads:        ['CRM & Leads', 'Manage your sales pipeline'],
  customers:    ['Customers', 'All active and inactive clients'],
  invoices:     ['Finance', 'Invoices and billing overview'],
  support:      ['Support Tickets', 'Open client support requests'],
  hr:           ['HR & Staff', 'Team and employee management'],
};

function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page)?.classList.add('active');
  document.querySelector(`[data-page="${page}"]`)?.classList.add('active');

  const [h, s] = PAGE_TITLES[page] || [page, ''];
  // On dashboard, show time-based greeting
  if (page === 'dashboard') {
    const hour = new Date().getHours();
    const tod = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
    document.getElementById('pageHeading').textContent = `Good ${tod}, Boedirep üåø`;
  } else {
    document.getElementById('pageHeading').textContent = h;
  }
  document.getElementById('pageSubheading').textContent = s;
  document.getElementById('sidebar').classList.remove('open');

  // Show/hide dashboard topbar actions
  document.getElementById('dashboardActions').style.display = page === 'dashboard' ? 'flex' : 'none';

  if (!loaded.has(page)) { loaded.add(page); loadPage(page); }
}

document.querySelectorAll('.nav-item').forEach(btn => {
  btn.addEventListener('click', () => navigate(btn.dataset.page));
});
document.getElementById('hamburger').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('open');
});

function loadPage(page) {
  if (page === 'leads')        loadLeads();
  else if (page === 'customers')  loadCustomers();
  else if (page === 'invoices')   loadInvoices();
  else if (page === 'support')    loadTickets();
  else if (page === 'hr')         loadHR();
  // analytics, programs, sessions, participants are stub pages ‚Äî nothing to load yet
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BADGE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function leadStatusBadge(status) {
  const map = {
    'Lead':'gray','Open':'green','Replied':'gold',
    'Opportunity':'blue','Quotation':'blue','Interested':'green',
    'Converted':'green','Lost Quotation':'red','Do Not Contact':'red'
  };
  return badge(map[status]||'gray', status||'‚Äî');
}
function qualBadge(q) {
  if (!q) return '‚Äî';
  const map = {'Unqualified':'red','In Process':'gold','Qualified':'green'};
  return badge(map[q]||'gray', q);
}
function custTypeBadge(t) {
  const map = {'Company':'blue','Individual':'green','Partnership':'gold'};
  return badge(map[t]||'gray', t||'‚Äî');
}
function statusBadge(s, map) {
  return badge(map[s]||'gray', s||'‚Äî');
}
function badge(color, text) {
  return `<span class="badge badge-${color}">${text}</span>`;
}
function priorityBadge(p) {
  const map = {'Low':'green','Medium':'gold','High':'red','Urgent':'red'};
  return badge(map[p]||'gray', p||'‚Äî');
}
function ticketStatusBadge(s) {
  const map = {'Open':'gold','Replied':'blue','Resolved':'green','Closed':'gray'};
  return badge(map[s]||'gray', s||'Open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGINATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPagination(elId, current, total, onChangeFn) {
  const el = document.getElementById(elId);
  if (total <= 1) { el.innerHTML = ''; return; }
  let html = `<div class="pagination"><span class="page-info">Page ${current} of ${total}</span>`;
  if (current > 1) html += `<button class="page-btn" onclick="${onChangeFn}(${current-1})">‚Äπ</button>`;
  const s = Math.max(1, current-2), e = Math.min(total, current+2);
  for (let p = s; p <= e; p++)
    html += `<button class="page-btn${p===current?' active':''}" onclick="${onChangeFn}(${p})">${p}</button>`;
  if (current < total) html += `<button class="page-btn" onclick="${onChangeFn}(${current+1})">‚Ä∫</button>`;
  el.innerHTML = html + '</div>';
}

function getPage(arr, page) {
  return arr.slice((page-1)*PER_PAGE, page*PER_PAGE);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEADS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadLeads() {
  const fields = JSON.stringify(['name','lead_name','first_name','last_name','company_name',
    'email_id','mobile_no','phone','status','qualification_status','utm_source',
    'lead_owner','job_title','city','country','type','request_type','whatsapp_no','creation']);
  const data = await apiGet(`/api/resource/Lead?fields=${fields}&limit=500&order_by=creation desc`);
  S.leads.all = data || [];
  S.leads.filtered = [...S.leads.all];
  S.leads.page = 1;
  renderLeads();
  updateDashLeads();
  document.getElementById('stat-leads').textContent = S.leads.all.length;
  const converted = S.leads.all.filter(l => l.status === 'Converted').length;
  document.getElementById('stat-leads-sub').textContent = `${converted} converted`;
}

function renderLeads() {
  const { filtered, page } = S.leads;
  document.getElementById('leadCountLabel').textContent =
    `${filtered.length} lead${filtered.length !== 1 ? 's' : ''}`;
  const tbody = document.getElementById('leadsBody');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üîÅ</div><p>No leads found</p></div></td></tr>`;
    document.getElementById('leadPagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = getPage(filtered, page).map(l => {
    const name = l.lead_name || `${l.first_name||''} ${l.last_name||''}`.trim() || l.name;
    const initials = (name[0]||'?').toUpperCase();
    const contact = l.email_id || l.mobile_no || l.phone || '‚Äî';
    const safeId = encodeURIComponent(l.name);
    return `<tr>
      <td><div class="cell-with-avatar">
        <div class="avatar-circle">${initials}</div>
        <div><div class="cell-main">${name}</div><div class="cell-sub">${l.job_title||''}</div></div>
      </div></td>
      <td>${l.company_name||'‚Äî'}</td>
      <td><div class="cell-main">${contact}</div>${l.mobile_no&&l.email_id?`<div class="cell-sub">${l.mobile_no}</div>`:''}</td>
      <td>${leadStatusBadge(l.status)}</td>
      <td>${qualBadge(l.qualification_status)}</td>
      <td>${l.utm_source||'‚Äî'}</td>
      <td class="cell-sub">${(l.lead_owner||'').split('@')[0]||'‚Äî'}</td>
      <td><div class="row-actions">
        <button class="action-btn view" onclick="viewLead('${safeId}')">View</button>
        <button class="action-btn edit" onclick="editLead('${safeId}')">Edit</button>
        <button class="action-btn del" onclick="confirmDelete('Lead','${safeId}','${name.replace(/'/g,"\\'")}')" >Delete</button>
      </div></td>
    </tr>`;
  }).join('');
  renderPagination('leadPagination', page, Math.ceil(filtered.length/PER_PAGE), 'setLeadPage');
}

window.setLeadPage = p => { S.leads.page = p; renderLeads(); };

function filterLeads() {
  const q  = document.getElementById('leadSearch').value.toLowerCase();
  const st = document.getElementById('leadStatusFilter').value;
  const qs = document.getElementById('leadQualFilter').value;
  S.leads.filtered = S.leads.all.filter(l => {
    const mQ  = !q  || [l.lead_name,l.email_id,l.company_name,l.mobile_no,l.first_name,l.last_name].some(v=>(v||'').toLowerCase().includes(q));
    const mSt = !st || l.status === st;
    const mQs = !qs || l.qualification_status === qs;
    return mQ && mSt && mQs;
  });
  S.leads.page = 1;
  renderLeads();
}

async function saveLead() {
  const first = document.getElementById('lf_first_name').value.trim();
  const company = document.getElementById('lf_company_name').value.trim();
  if (!first && !company) return showToast('First name or organization required', 'error');
  const body = {
    first_name: first,
    last_name: document.getElementById('lf_last_name').value.trim(),
    company_name: company,
    email_id: document.getElementById('lf_email_id').value.trim(),
    mobile_no: document.getElementById('lf_mobile_no').value.trim(),
    whatsapp_no: document.getElementById('lf_whatsapp_no').value.trim(),
    phone: document.getElementById('lf_phone').value.trim(),
    job_title: document.getElementById('lf_job_title').value.trim(),
    status: document.getElementById('lf_status').value,
    type: document.getElementById('lf_type').value,
    request_type: document.getElementById('lf_request_type').value,
    qualification_status: document.getElementById('lf_qualification_status').value,
    city: document.getElementById('lf_city').value.trim(),
    country: document.getElementById('lf_country').value.trim(),
    website: document.getElementById('lf_website').value.trim(),
    no_of_employees: document.getElementById('lf_no_of_employees').value,
    doctype: 'Lead'
  };
  try {
    await apiPost('/api/resource/Lead', body);
    showToast('Lead saved successfully', 'success');
    closeModal('modalLead');
    loaded.delete('leads'); // force reload
    loadLeads();
  } catch(e) { showToast('Error: ' + (e.message||'Save failed'), 'error'); }
}

// Dashboard widget
function updateDashLeads() {
  const recent = S.leads.all.slice(0, 6);
  const el = document.getElementById('dashLeads');
  if (!recent.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">üîÅ</div><p>No leads yet</p></div>`;
    return;
  }
  el.innerHTML = `<table class="data-table">
    <thead><tr><th>Name</th><th>Company</th><th>Status</th></tr></thead>
    <tbody>${recent.map(l => {
      const name = l.lead_name || `${l.first_name||''} ${l.last_name||''}`.trim() || l.name;
      return `<tr>
        <td><div class="cell-with-avatar">
          <div class="avatar-circle">${(name[0]||'?').toUpperCase()}</div>
          <div class="cell-main">${name}</div>
        </div></td>
        <td class="cell-sub">${l.company_name||'‚Äî'}</td>
        <td>${leadStatusBadge(l.status)}</td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUSTOMERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCustomers() {
  const fields = JSON.stringify(['name','customer_name','customer_type','customer_group',
    'territory','email_id','mobile_no','account_manager','industry','market_segment',
    'website','disabled','default_currency','creation']);
  const data = await apiGet(`/api/resource/Customer?fields=${fields}&limit=500&order_by=creation desc`);
  S.customers.all = data || [];
  S.customers.filtered = [...S.customers.all];
  S.customers.page = 1;

  // Populate group filter
  const groups = [...new Set(S.customers.all.map(c=>c.customer_group).filter(Boolean))];
  const gf = document.getElementById('customerGroupFilter');
  gf.innerHTML = '<option value="">All Groups</option>' + groups.map(g=>`<option>${g}</option>`).join('');

  renderCustomers();
  updateDashCustomers();
  const active = S.customers.all.filter(c=>!c.disabled).length;
  document.getElementById('stat-customers').textContent = active;
  document.getElementById('stat-customers-sub').textContent = `${S.customers.all.length} total`;
}

function renderCustomers() {
  const { filtered, page } = S.customers;
  document.getElementById('customerCountLabel').textContent =
    `${filtered.length} customer${filtered.length !== 1 ? 's' : ''}`;
  const tbody = document.getElementById('customersBody');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üë•</div><p>No customers found</p></div></td></tr>`;
    document.getElementById('customerPagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = getPage(filtered, page).map(c => {
    const safeId = encodeURIComponent(c.name);
    return `
    <tr>
      <td><div class="cell-with-avatar">
        <div class="avatar-circle" style="background:linear-gradient(135deg,#2D7D9A,#1A5269)">${(c.customer_name||'?')[0].toUpperCase()}</div>
        <div class="cell-main">${c.customer_name||'‚Äî'}</div>
      </div></td>
      <td>${custTypeBadge(c.customer_type)}</td>
      <td>${c.customer_group||'‚Äî'}</td>
      <td>${c.territory||'‚Äî'}</td>
      <td><div class="cell-main">${c.email_id||'‚Äî'}</div>${c.mobile_no?`<div class="cell-sub">${c.mobile_no}</div>`:''}</td>
      <td class="cell-sub">${(c.account_manager||'').split('@')[0]||'‚Äî'}</td>
      <td>${c.disabled ? badge('red','Disabled') : badge('green','Active')}</td>
      <td><div class="row-actions">
        <button class="action-btn view" onclick="viewCustomer('${safeId}')">View</button>
        <button class="action-btn edit" onclick="editCustomer('${safeId}')">Edit</button>
        <button class="action-btn del" onclick="confirmDelete('Customer','${safeId}','${(c.customer_name||'').replace(/'/g,"\\'")}')">Delete</button>
      </div></td>
    </tr>
  `}).join('');
  renderPagination('customerPagination', page, Math.ceil(filtered.length/PER_PAGE), 'setCustPage');
}

window.setCustPage = p => { S.customers.page = p; renderCustomers(); };

function filterCustomers() {
  const q = document.getElementById('customerSearch').value.toLowerCase();
  const t = document.getElementById('customerTypeFilter').value;
  const g = document.getElementById('customerGroupFilter').value;
  S.customers.filtered = S.customers.all.filter(c => {
    const mQ = !q || [c.customer_name,c.customer_group,c.territory,c.email_id].some(v=>(v||'').toLowerCase().includes(q));
    const mT = !t || c.customer_type === t;
    const mG = !g || c.customer_group === g;
    return mQ && mT && mG;
  });
  S.customers.page = 1;
  renderCustomers();
}

async function saveCustomer() {
  const name = document.getElementById('cf_customer_name').value.trim();
  if (!name) return showToast('Customer name required', 'error');
  const body = {
    customer_name: name,
    customer_type: document.getElementById('cf_customer_type').value,
    customer_group: document.getElementById('cf_customer_group').value.trim(),
    territory: document.getElementById('cf_territory').value.trim(),
    account_manager: document.getElementById('cf_account_manager').value.trim(),
    website: document.getElementById('cf_website').value.trim(),
    industry: document.getElementById('cf_industry').value.trim(),
    market_segment: document.getElementById('cf_market_segment').value.trim(),
    tax_id: document.getElementById('cf_tax_id').value.trim(),
    default_currency: document.getElementById('cf_default_currency').value.trim(),
    customer_details: document.getElementById('cf_customer_details').value.trim(),
    doctype: 'Customer'
  };
  try {
    await apiPost('/api/resource/Customer', body);
    showToast('Customer saved', 'success');
    closeModal('modalCustomer');
    loaded.delete('customers');
    loadCustomers();
  } catch(e) { showToast('Error: ' + (e.message||'Save failed'), 'error'); }
}

function updateDashCustomers() {
  const recent = S.customers.all.slice(0, 5);
  const el = document.getElementById('dashCustomers');
  if (!recent.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">üë•</div><p>No customers yet</p></div>`;
    return;
  }
  el.innerHTML = recent.map(c => `
    <div class="staff-item">
      <div class="avatar-circle" style="background:linear-gradient(135deg,#2D7D9A,#1A5269);border-radius:10px;">${(c.customer_name||'?')[0].toUpperCase()}</div>
      <div><div class="staff-name">${c.customer_name}</div><div class="staff-role">${c.customer_group||''} ${c.territory?'¬∑ '+c.territory:''}</div></div>
      <div style="margin-left:auto">${custTypeBadge(c.customer_type)}</div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVOICES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadInvoices() {
  const fields = JSON.stringify(['name','customer','posting_date','due_date','grand_total','status','docstatus','outstanding_amount']);
  const data = await apiGet(`/api/resource/Sales Invoice?fields=${fields}&limit=300&order_by=creation desc`);
  S.invoices.all = data || [];
  S.invoices.filtered = [...S.invoices.all];
  S.invoices.page = 1;
  renderInvoices();
  // Dashboard stat
  const unpaid = S.invoices.all.filter(i => i.status !== 'Paid' && i.docstatus !== 2).length;
  document.getElementById('stat-invoices').textContent = unpaid;
  document.getElementById('stat-invoices-sub').textContent = 'unpaid invoices';
}

function renderInvoices() {
  const { filtered, page } = S.invoices;
  document.getElementById('invoiceCountLabel').textContent =
    `${filtered.length} invoice${filtered.length !== 1 ? 's' : ''}`;
  const tbody = document.getElementById('invoicesBody');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üí∞</div><p>No invoices found</p></div></td></tr>`;
    document.getElementById('invoicePagination').innerHTML = '';
    return;
  }
  const statusMap = {0:'Draft',1:'Submitted',2:'Cancelled'};
  tbody.innerHTML = getPage(filtered, page).map(inv => {
    const st = inv.status || statusMap[inv.docstatus] || 'Draft';
    const sc = {'Paid':'green','Overdue':'red','Submitted':'gold','Draft':'gray','Return':'red','Cancelled':'gray'}[st]||'gray';
    const safeId = encodeURIComponent(inv.name);
    return `<tr>
      <td class="cell-main">${inv.name}</td>
      <td>${inv.customer||'‚Äî'}</td>
      <td>${inv.posting_date||'‚Äî'}</td>
      <td>${inv.due_date||'‚Äî'}</td>
      <td class="cell-main">IDR ${(inv.grand_total||0).toLocaleString()}</td>
      <td>${badge(sc, st)}</td>
      <td><div class="row-actions">
        <button class="action-btn view" onclick="viewInvoice('${safeId}')">View</button>
        <button class="action-btn convert" onclick="window.open('${SITE}/Sales Invoice/${inv.name}','_blank')">‚Üó Frappe</button>
      </div></td>
    </tr>`;
  }).join('');
  renderPagination('invoicePagination', page, Math.ceil(filtered.length/PER_PAGE), 'setInvPage');
}

window.setInvPage = p => { S.invoices.page = p; renderInvoices(); };

function filterInvoices() {
  const q = document.getElementById('invoiceSearch').value.toLowerCase();
  const s = document.getElementById('invoiceStatusFilter').value;
  S.invoices.filtered = S.invoices.all.filter(i => {
    const mQ = !q || (i.customer||'').toLowerCase().includes(q) || (i.name||'').toLowerCase().includes(q);
    const mS = !s || (i.status||'').includes(s);
    return mQ && mS;
  });
  S.invoices.page = 1;
  renderInvoices();
}

async function saveInvoice() {
  const customer = document.getElementById('if_customer').value.trim();
  if (!customer) return showToast('Customer required', 'error');
  try {
    await apiPost('/api/resource/Sales Invoice', {
      customer,
      posting_date: document.getElementById('if_posting_date').value,
      due_date: document.getElementById('if_due_date').value,
      doctype: 'Sales Invoice'
    });
    showToast('Invoice created', 'success');
    closeModal('modalInvoice');
    loaded.delete('invoices');
    loadInvoices();
  } catch(e) { showToast('Error: ' + (e.message||'Failed'), 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPPORT TICKETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadTickets() {
  const fields = JSON.stringify(['name','subject','customer','status','priority','creation','raised_by']);
  const data = await apiGet(`/api/resource/HD Ticket?fields=${fields}&limit=200&order_by=creation desc`);
  S.tickets.all = data || [];
  S.tickets.filtered = [...S.tickets.all];
  S.tickets.page = 1;
  renderTickets();

  const open = S.tickets.all.filter(t => !['Resolved','Closed'].includes(t.status)).length;
  document.getElementById('stat-tickets').textContent = open;
  document.getElementById('stat-tickets-sub').textContent = 'unresolved';
  const badge_el = document.getElementById('ticketBadge');
  if (open > 0) { badge_el.textContent = open; badge_el.style.display = ''; }
  updateDashTickets();
}

function renderTickets() {
  const { filtered, page } = S.tickets;
  document.getElementById('ticketCountLabel').textContent =
    `${filtered.length} ticket${filtered.length !== 1 ? 's' : ''}`;
  const tbody = document.getElementById('ticketsBody');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üéß</div><p>No tickets found</p></div></td></tr>`;
    document.getElementById('ticketPagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = getPage(filtered, page).map(t => `
    <tr>
      <td class="cell-main">${t.name}</td>
      <td>${t.subject||'‚Äî'}</td>
      <td>${t.customer||t.raised_by||'‚Äî'}</td>
      <td>${ticketStatusBadge(t.status)}</td>
      <td>${priorityBadge(t.priority)}</td>
      <td class="cell-sub">${(t.creation||'').split(' ')[0]||'‚Äî'}</td>
    </tr>
  `).join('');
  renderPagination('ticketPagination', page, Math.ceil(filtered.length/PER_PAGE), 'setTicketPage');
}

window.setTicketPage = p => { S.tickets.page = p; renderTickets(); };

function filterTickets() {
  const q  = document.getElementById('ticketSearch').value.toLowerCase();
  const st = document.getElementById('ticketStatusFilter').value;
  const pr = document.getElementById('ticketPriorityFilter').value;
  S.tickets.filtered = S.tickets.all.filter(t => {
    const mQ  = !q  || (t.subject||'').toLowerCase().includes(q) || (t.customer||'').toLowerCase().includes(q);
    const mSt = !st || t.status === st;
    const mPr = !pr || t.priority === pr;
    return mQ && mSt && mPr;
  });
  S.tickets.page = 1;
  renderTickets();
}

function updateDashTickets() {
  const open = S.tickets.all.filter(t => !['Resolved','Closed'].includes(t.status)).slice(0, 4);
  const el = document.getElementById('dashTickets');
  if (!open.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">üéß</div><p>No open tickets</p></div>`;
    return;
  }
  const priorityDot = p => {
    const c = {'High':'high','Urgent':'high','Medium':'medium','Low':'low'}[p]||'low';
    return `<div class="priority-dot ${c}"></div>`;
  };
  el.innerHTML = open.map(t => `
    <div class="ticket-item">
      <div class="ticket-top">
        <div class="ticket-subject">${t.subject||'‚Äî'}</div>
        <div class="ticket-id">${t.name}</div>
      </div>
      <div class="ticket-meta">
        ${priorityDot(t.priority)}
        <span>${t.priority||'‚Äî'} ¬∑ ${t.customer||t.raised_by||'‚Äî'}</span>
        <span>${(t.creation||'').split(' ')[0]}</span>
      </div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadHR() {
  const fields = JSON.stringify(['name','employee_name','designation','department','company_email','status','date_of_joining']);
  const data = await apiGet(`/api/resource/Employee?fields=${fields}&limit=200&order_by=employee_name asc`);
  S.hr.all = data || [];
  S.hr.filtered = [...S.hr.all];
  S.hr.page = 1;
  renderHR();
}

function renderHR() {
  const { filtered, page } = S.hr;
  document.getElementById('hrCountLabel').textContent =
    `${filtered.length} employee${filtered.length !== 1 ? 's' : ''}`;
  const tbody = document.getElementById('hrBody');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">üë§</div><p>No employees found</p></div></td></tr>`;
    document.getElementById('hrPagination').innerHTML = '';
    return;
  }
  const colors = ['linear-gradient(135deg,#4A7C59,#2D5C3A)','linear-gradient(135deg,#C4942A,#8B6520)','linear-gradient(135deg,#5C4A32,#3D2E1A)','linear-gradient(135deg,#2D7D9A,#1A5269)','linear-gradient(135deg,#6B5B95,#4A3D6B)'];
  tbody.innerHTML = getPage(filtered, page).map((e, i) => `
    <tr>
      <td><div class="cell-with-avatar">
        <div class="staff-avatar" style="background:${colors[i%colors.length]}">${(e.employee_name||'?')[0].toUpperCase()}</div>
        <div><div class="cell-main">${e.employee_name||e.name}</div><div class="cell-sub">${e.date_of_joining?'Joined: '+e.date_of_joining:''}</div></div>
      </div></td>
      <td>${e.designation||'‚Äî'}</td>
      <td>${e.department||'‚Äî'}</td>
      <td>${e.company_email||'‚Äî'}</td>
      <td>${e.status==='Active' ? badge('green','Active') : badge('red', e.status||'Inactive')}</td>
    </tr>
  `).join('');
  renderPagination('hrPagination', page, Math.ceil(filtered.length/PER_PAGE), 'setHRPage');
}

window.setHRPage = p => { S.hr.page = p; renderHR(); };

function filterHR() {
  const q  = document.getElementById('hrSearch').value.toLowerCase();
  const st = document.getElementById('hrStatusFilter').value;
  S.hr.filtered = S.hr.all.filter(e => {
    const mQ  = !q  || [e.employee_name,e.designation,e.department,e.company_email].some(v=>(v||'').toLowerCase().includes(q));
    const mSt = !st || e.status === st;
    return mQ && mSt;
  });
  S.hr.page = 1;
  renderHR();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _toastTimer;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = `show ${type}`;
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.className = '', 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEAD VIEW / EDIT / DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _currentViewLead = null;

function viewLead(safeId) {
  const id = decodeURIComponent(safeId);
  const l = S.leads.all.find(x => x.name === id);
  if (!l) return;
  _currentViewLead = l;
  const name = l.lead_name || `${l.first_name||''} ${l.last_name||''}`.trim() || l.name;
  document.getElementById('viewLeadTitle').textContent = name;
  document.getElementById('viewLeadName').textContent = name;
  document.getElementById('viewLeadJob').textContent = l.job_title || (l.company_name ? `at ${l.company_name}` : '‚Äî');
  document.getElementById('viewLeadAvatar').textContent = (name[0]||'?').toUpperCase();
  document.getElementById('viewLeadStatusBadge').innerHTML = leadStatusBadge(l.status) + ' ' + qualBadge(l.qualification_status);
  const fields = [
    ['Email', l.email_id], ['Mobile', l.mobile_no], ['WhatsApp', l.whatsapp_no], ['Phone', l.phone],
    ['Company', l.company_name], ['Lead Type', l.type], ['Request Type', l.request_type],
    ['Source', l.utm_source], ['Owner', l.lead_owner], ['City', l.city], ['Country', l.country],
    ['Website', l.website], ['No. of Employees', l.no_of_employees], ['Created', (l.creation||'').split(' ')[0]],
  ];
  document.getElementById('viewLeadDetails').innerHTML = fields.map(([k,v]) =>
    `<div class="detail-item"><div class="detail-key">${k}</div><div class="detail-val">${v||'‚Äî'}</div></div>`
  ).join('');
  openModal('modalViewLead');
}

function openEditLeadFromView() {
  closeModal('modalViewLead');
  if (_currentViewLead) editLead(encodeURIComponent(_currentViewLead.name));
}

function editLead(safeId) {
  const id = decodeURIComponent(safeId);
  const l = S.leads.all.find(x => x.name === id);
  if (!l) return;
  document.getElementById('el_name').value = l.name;
  document.getElementById('el_first_name').value = l.first_name||'';
  document.getElementById('el_last_name').value = l.last_name||'';
  document.getElementById('el_email_id').value = l.email_id||'';
  document.getElementById('el_mobile_no').value = l.mobile_no||'';
  document.getElementById('el_whatsapp_no').value = l.whatsapp_no||'';
  document.getElementById('el_phone').value = l.phone||'';
  document.getElementById('el_company_name').value = l.company_name||'';
  document.getElementById('el_job_title').value = l.job_title||'';
  document.getElementById('el_status').value = l.status||'Lead';
  document.getElementById('el_type').value = l.type||'';
  document.getElementById('el_qualification_status').value = l.qualification_status||'Unqualified';
  document.getElementById('el_city').value = l.city||'';
  document.getElementById('el_country').value = l.country||'';
  document.getElementById('el_website').value = l.website||'';
  openModal('modalEditLead');
}

async function updateLead() {
  const name = document.getElementById('el_name').value;
  const body = {
    first_name: document.getElementById('el_first_name').value.trim(),
    last_name: document.getElementById('el_last_name').value.trim(),
    email_id: document.getElementById('el_email_id').value.trim(),
    mobile_no: document.getElementById('el_mobile_no').value.trim(),
    whatsapp_no: document.getElementById('el_whatsapp_no').value.trim(),
    phone: document.getElementById('el_phone').value.trim(),
    company_name: document.getElementById('el_company_name').value.trim(),
    job_title: document.getElementById('el_job_title').value.trim(),
    status: document.getElementById('el_status').value,
    type: document.getElementById('el_type').value,
    qualification_status: document.getElementById('el_qualification_status').value,
    city: document.getElementById('el_city').value.trim(),
    country: document.getElementById('el_country').value.trim(),
    website: document.getElementById('el_website').value.trim(),
  };
  try {
    await apiPut(`/api/resource/Lead/${encodeURIComponent(name)}`, body);
    showToast('Lead updated', 'success');
    closeModal('modalEditLead');
    loaded.delete('leads'); loadLeads();
  } catch(e) { showToast('Error: ' + (e.message||'Update failed'), 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUSTOMER VIEW / EDIT / DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _currentViewCust = null;

function viewCustomer(safeId) {
  const id = decodeURIComponent(safeId);
  const c = S.customers.all.find(x => x.name === id);
  if (!c) return;
  _currentViewCust = c;
  document.getElementById('viewCustAvatar').textContent = (c.customer_name||'?')[0].toUpperCase();
  document.getElementById('viewCustName').textContent = c.customer_name||'‚Äî';
  document.getElementById('viewCustGroup').textContent = [c.customer_group, c.territory].filter(Boolean).join(' ¬∑ ') || '‚Äî';
  document.getElementById('viewCustTypeBadge').innerHTML = custTypeBadge(c.customer_type) + (c.disabled ? ' ' + badge('red','Disabled') : ' ' + badge('green','Active'));
  const fields = [
    ['Email', c.email_id], ['Mobile', c.mobile_no], ['Account Manager', c.account_manager],
    ['Territory', c.territory], ['Customer Group', c.customer_group], ['Industry', c.industry],
    ['Market Segment', c.market_segment], ['Website', c.website], ['Currency', c.default_currency],
    ['Created', (c.creation||'').split(' ')[0]],
  ];
  document.getElementById('viewCustDetails').innerHTML = fields.map(([k,v]) =>
    `<div class="detail-item"><div class="detail-key">${k}</div><div class="detail-val">${v||'‚Äî'}</div></div>`
  ).join('');
  openModal('modalViewCustomer');
}

function openEditCustFromView() {
  closeModal('modalViewCustomer');
  if (_currentViewCust) editCustomer(encodeURIComponent(_currentViewCust.name));
}

function editCustomer(safeId) {
  const id = decodeURIComponent(safeId);
  const c = S.customers.all.find(x => x.name === id);
  if (!c) return;
  document.getElementById('ec_name').value = c.name;
  document.getElementById('ec_customer_name').value = c.customer_name||'';
  document.getElementById('ec_customer_type').value = c.customer_type||'Company';
  document.getElementById('ec_customer_group').value = c.customer_group||'';
  document.getElementById('ec_territory').value = c.territory||'';
  document.getElementById('ec_email_id').value = c.email_id||'';
  document.getElementById('ec_mobile_no').value = c.mobile_no||'';
  document.getElementById('ec_account_manager').value = c.account_manager||'';
  document.getElementById('ec_website').value = c.website||'';
  document.getElementById('ec_industry').value = c.industry||'';
  document.getElementById('ec_market_segment').value = c.market_segment||'';
  document.getElementById('ec_customer_details').value = c.customer_details||'';
  openModal('modalEditCustomer');
}

async function updateCustomer() {
  const name = document.getElementById('ec_name').value;
  if (!document.getElementById('ec_customer_name').value.trim()) return showToast('Customer name required', 'error');
  const body = {
    customer_name: document.getElementById('ec_customer_name').value.trim(),
    customer_type: document.getElementById('ec_customer_type').value,
    customer_group: document.getElementById('ec_customer_group').value.trim(),
    territory: document.getElementById('ec_territory').value.trim(),
    account_manager: document.getElementById('ec_account_manager').value.trim(),
    website: document.getElementById('ec_website').value.trim(),
    industry: document.getElementById('ec_industry').value.trim(),
    market_segment: document.getElementById('ec_market_segment').value.trim(),
    customer_details: document.getElementById('ec_customer_details').value.trim(),
  };
  try {
    await apiPut(`/api/resource/Customer/${encodeURIComponent(name)}`, body);
    showToast('Customer updated', 'success');
    closeModal('modalEditCustomer');
    loaded.delete('customers'); loadCustomers();
  } catch(e) { showToast('Error: ' + (e.message||'Update failed'), 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVOICE VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function viewInvoice(safeId) {
  const id = decodeURIComponent(safeId);
  const inv = S.invoices.all.find(x => x.name === id);
  if (!inv) return;
  document.getElementById('viewInvTitle').textContent = inv.name;
  const statusMap = {0:'Draft',1:'Submitted',2:'Cancelled'};
  const st = inv.status || statusMap[inv.docstatus] || 'Draft';
  const fields = [
    ['Invoice #', inv.name], ['Customer', inv.customer], ['Status', st],
    ['Posting Date', inv.posting_date], ['Due Date', inv.due_date],
    ['Grand Total', `IDR ${(inv.grand_total||0).toLocaleString()}`],
    ['Outstanding', `IDR ${(inv.outstanding_amount||0).toLocaleString()}`],
  ];
  document.getElementById('viewInvDetails').innerHTML = fields.map(([k,v]) =>
    `<div class="detail-item"><div class="detail-key">${k}</div><div class="detail-val">${v||'‚Äî'}</div></div>`
  ).join('');
  document.getElementById('viewInvFrappeLink').onclick = () => window.open(`${SITE}/Sales Invoice/${inv.name}`, '_blank');
  openModal('modalViewInvoice');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GENERIC DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _pendingDelete = null;

function confirmDelete(doctype, safeId, label) {
  _pendingDelete = { doctype, id: decodeURIComponent(safeId), label };
  document.getElementById('deleteConfirmMsg').textContent =
    `Are you sure you want to delete "${label}"? This action cannot be undone in Frappe.`;
  document.getElementById('deleteConfirmBtn').onclick = executeDelete;
  openModal('modalConfirmDelete');
}

async function executeDelete() {
  if (!_pendingDelete) return;
  const { doctype, id } = _pendingDelete;
  try {
    await apiDelete(`/api/resource/${doctype}/${encodeURIComponent(id)}`);
    showToast('Deleted successfully', 'success');
    closeModal('modalConfirmDelete');
    if (doctype === 'Lead') { loaded.delete('leads'); loadLeads(); }
    else if (doctype === 'Customer') { loaded.delete('customers'); loadCustomers(); }
  } catch(e) { showToast('Error: ' + (e.message||'Delete failed'), 'error'); }
  _pendingDelete = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API PUT / DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiPut(endpoint, body) {
  const r = await fetch(`${SITE}${endpoint}`, {
    method: 'PUT', headers: HEADERS, body: JSON.stringify(body)
  });
  const d = await r.json();
  if (!r.ok) throw new Error(d.exception || d.message || r.status);
  return d.data ?? d;
}

async function apiDelete(endpoint) {
  const r = await fetch(`${SITE}${endpoint}`, { method: 'DELETE', headers: HEADERS });
  const d = await r.json();
  if (!r.ok) throw new Error(d.exception || d.message || r.status);
  return d;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleNotifDropdown() {
  document.getElementById('notifDropdown').classList.toggle('open');
}
document.addEventListener('click', e => {
  const btn = e.target.closest('.notif-btn');
  if (!btn) document.getElementById('notifDropdown').classList.remove('open');
});

async function loadNotifications() {
  // Pull recent open tickets and overdue invoices as notifications
  const items = [];
  const openTickets = S.tickets.all.filter(t => !['Resolved','Closed'].includes(t.status)).slice(0,3);
  openTickets.forEach(t => items.push({ title: `Ticket: ${t.subject||t.name}`, sub: `${t.priority||'Open'} ¬∑ ${t.customer||t.raised_by||''}` }));
  const overdueInv = S.invoices.all.filter(i => i.status === 'Overdue').slice(0,3);
  overdueInv.forEach(i => items.push({ title: `Overdue Invoice: ${i.name}`, sub: `${i.customer} ‚Äî IDR ${(i.grand_total||0).toLocaleString()}` }));

  const el = document.getElementById('notifList');
  if (!items.length) {
    el.innerHTML = `<div style="padding:1rem;text-align:center;color:var(--text-faint);font-size:0.82rem;">All caught up! üåø</div>`;
    return;
  }
  document.getElementById('notifDot').classList.add('show');
  el.innerHTML = items.map(n => `
    <div class="notif-item">
      <div class="notif-item-title">${n.title}</div>
      <div class="notif-item-sub">${n.sub}</div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE TITLES ‚Äî updated to include new pages
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setCurr(btn, c) {
  document.querySelectorAll('.curr-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  // Update greeting
  const hour = new Date().getHours();
  const tod  = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
  document.getElementById('pageHeading').textContent = `Good ${tod}, Boedirep üåø`;

  await checkConnection();

  // Load dashboard data in parallel
  loaded.add('dashboard');
  await Promise.all([loadLeads(), loadCustomers()]);

  // Load invoices + tickets for dashboard stats
  await Promise.all([loadInvoices(), loadTickets()]);
  loaded.add('invoices');
  loaded.add('support');

  // Populate notifications after data loaded
  loadNotifications();
}

init();
</script>
</body>
</html>

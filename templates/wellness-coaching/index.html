<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boedirep ‚Äî Wellness Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --sage: #4A7C59;
    --sage-light: #6B9E78;
    --sage-dim: #2D5C3A;
    --sage-faint: rgba(74,124,89,0.08);
    --sage-border: rgba(74,124,89,0.18);
    --cream: #FAF7F2;
    --cream2: #F2EDE4;
    --cream3: #E8E0D4;
    --brown: #5C4A32;
    --brown-light: #8B7355;
    --text: #1C1C1C;
    --text-dim: #6B6460;
    --text-faint: #9E9890;
    --white: #FFFFFF;
    --gold: #C4942A;
    --gold-light: #E8B84B;
    --red: #C0392B;
    --sidebar-w: 240px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--cream);
    color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif;
    display: flex;
    min-height: 100vh;
  }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--sage-dim);
    min-height: 100vh;
    position: fixed;
    left: 0; top: 0;
    display: flex;
    flex-direction: column;
    z-index: 50;
  }
  .sidebar-brand {
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .brand-logo {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif;
    font-weight: 700; font-size: 1.1rem;
    color: white; margin-bottom: 0.75rem;
  }
  .brand-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem; font-weight: 700;
    color: white;
  }
  .brand-tag { font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 0.2rem; }
  .sidebar-nav { flex: 1; padding: 1.5rem 0; }
  .nav-section { padding: 0 1rem; margin-bottom: 0.25rem; }
  .nav-section-label {
    font-size: 0.65rem; letter-spacing: 0.12em;
    text-transform: uppercase; color: rgba(255,255,255,0.35);
    padding: 0.75rem 0.5rem 0.4rem; font-weight: 600;
  }
  .nav-item {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.65rem 0.75rem; border-radius: 8px;
    color: rgba(255,255,255,0.65);
    font-size: 0.875rem; font-weight: 500;
    cursor: pointer; transition: all 0.2s;
    margin-bottom: 0.1rem; border: none;
    background: transparent; width: 100%; text-align: left;
  }
  .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
  .nav-item.active { background: rgba(255,255,255,0.15); color: white; }
  .nav-item.active .nav-icon { color: var(--gold-light); }
  .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }
  .nav-badge {
    margin-left: auto; background: var(--gold);
    color: white; font-size: 0.65rem; font-weight: 700;
    padding: 0.15rem 0.5rem; border-radius: 100px;
  }
  .sidebar-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  .user-card { display: flex; align-items: center; gap: 0.75rem; }
  .user-avatar {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--gold-light), var(--gold));
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 0.8rem;
    font-weight: 700; color: white; flex-shrink: 0;
  }
  .user-name { font-size: 0.82rem; font-weight: 600; color: white; }
  .user-role { font-size: 0.7rem; color: rgba(255,255,255,0.45); }

  /* MAIN */
  .main { margin-left: var(--sidebar-w); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }
  .topbar {
    background: var(--white); border-bottom: 1px solid var(--cream3);
    padding: 1rem 2rem; display: flex; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 40;
  }
  .topbar-left h1 { font-family: 'Playfair Display', serif; font-size: 1.35rem; font-weight: 700; }
  .topbar-left p { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.1rem; }
  .topbar-right { display: flex; align-items: center; gap: 1rem; }
  .topbar-btn {
    background: var(--sage-faint); border: 1px solid var(--sage-border);
    color: var(--sage); padding: 0.5rem 1.1rem; border-radius: 7px;
    font-size: 0.82rem; font-weight: 600; cursor: pointer;
    font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s;
  }
  .topbar-btn:hover { background: var(--sage); color: white; }
  .topbar-btn.primary { background: var(--sage); color: white; border-color: var(--sage); }

  /* PAGES */
  .page { display: none; padding: 2rem; flex: 1; }
  .page.active { display: block; }

  /* LOADING */
  .loading-spinner {
    display: flex; align-items: center; justify-content: center;
    padding: 3rem; flex-direction: column; gap: 1rem;
  }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--cream3);
    border-top-color: var(--sage);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 0.85rem; color: var(--text-faint); }

  /* ERROR */
  .error-box {
    background: rgba(192,57,43,0.06);
    border: 1px solid rgba(192,57,43,0.2);
    border-radius: 10px; padding: 1.25rem 1.5rem;
    font-size: 0.85rem; color: var(--red);
    margin-bottom: 1rem;
  }

  /* CONNECTION STATUS */
  .conn-status {
    display: flex; align-items: center; gap: 0.5rem;
    font-size: 0.75rem; font-weight: 600;
    padding: 0.35rem 0.85rem; border-radius: 100px;
  }
  .conn-status.connected { background: rgba(74,124,89,0.1); color: var(--sage); }
  .conn-status.disconnected { background: rgba(192,57,43,0.08); color: var(--red); }
  .conn-status.loading { background: rgba(196,148,42,0.1); color: var(--gold); }
  .conn-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }

  /* STATS */
  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 1.25rem; margin-bottom: 1.75rem;
  }
  .stat-card {
    background: var(--white); border: 1px solid var(--cream3);
    border-radius: 14px; padding: 1.5rem; position: relative;
    overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.07); }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .stat-card.green::before { background: linear-gradient(90deg, var(--sage), var(--sage-light)); }
  .stat-card.gold::before { background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
  .stat-card.brown::before { background: linear-gradient(90deg, var(--brown), var(--brown-light)); }
  .stat-card.red::before { background: var(--red); }
  .stat-label { font-size: 0.75rem; color: var(--text-faint); letter-spacing: 0.04em; text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; }
  .stat-value { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 0.4rem; }
  .stat-change { font-size: 0.78rem; color: var(--text-dim); }
  .stat-change.up { color: var(--sage); }
  .stat-change.down { color: var(--red); }
  .stat-icon {
    position: absolute; top: 1.25rem; right: 1.25rem;
    width: 36px; height: 36px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
  }
  .stat-icon.green { background: var(--sage-faint); }
  .stat-icon.gold { background: rgba(196,148,42,0.08); }
  .stat-icon.red { background: rgba(192,57,43,0.08); }

  /* CARDS */
  .card { background: var(--white); border: 1px solid var(--cream3); border-radius: 14px; overflow: hidden; margin-bottom: 1.5rem; }
  .card-header {
    padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--cream2);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; }
  .card-subtitle { font-size: 0.75rem; color: var(--text-faint); margin-top: 0.1rem; }

  /* TABLE */
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th {
    font-size: 0.7rem; font-weight: 700; letter-spacing: 0.06em;
    text-transform: uppercase; color: var(--text-faint);
    padding: 0.75rem 1.5rem; text-align: left;
    background: var(--cream); border-bottom: 1px solid var(--cream3);
  }
  .data-table td { padding: 0.9rem 1.5rem; font-size: 0.85rem; border-bottom: 1px solid var(--cream2); }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: var(--cream); }

  /* PILLS */
  .pill {
    font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.65rem;
    border-radius: 100px; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .pill.paid { background: rgba(74,124,89,0.1); color: var(--sage); }
  .pill.unpaid, .pill.overdue { background: rgba(192,57,43,0.08); color: var(--red); }
  .pill.draft { background: rgba(196,148,42,0.1); color: var(--gold); }
  .pill.open { background: rgba(192,57,43,0.08); color: var(--red); }
  .pill.resolved { background: rgba(74,124,89,0.1); color: var(--sage); }
  .pill.replied { background: rgba(196,148,42,0.1); color: var(--gold); }
  .pill.active-emp { background: rgba(74,124,89,0.1); color: var(--sage); }

  /* EMPTY STATE */
  .empty-state {
    text-align: center; padding: 3rem;
    color: var(--text-faint); font-size: 0.9rem;
  }
  .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }

  /* SETUP BANNER */
  .setup-banner {
    background: linear-gradient(135deg, rgba(196,148,42,0.12), rgba(196,148,42,0.05));
    border: 1px solid rgba(196,148,42,0.3);
    border-radius: 12px; padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem; display: flex;
    align-items: center; gap: 1rem;
  }
  .setup-banner-icon { font-size: 1.5rem; flex-shrink: 0; }
  .setup-banner-text { font-size: 0.875rem; line-height: 1.6; }
  .setup-banner-text strong { color: var(--gold); display: block; margin-bottom: 0.2rem; }

  @media (max-width: 1100px) { .stats-row { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .main { margin-left: 0; }
    .stats-row { grid-template-columns: repeat(2,1fr); }
    .grid-2 { grid-template-columns: 1fr; }
    .page { padding: 1rem; }
  }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <div class="brand-logo">B</div>
    <div class="brand-name">Boedirep</div>
    <div class="brand-tag">Wellness Coaching</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-section-label">Overview</div>
      <button class="nav-item active" onclick="showPage('dashboard')">
        <span class="nav-icon">‚¨°</span> Dashboard
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-section-label">Business</div>
      <button class="nav-item" onclick="showPage('finance')">
        <span class="nav-icon">üí∞</span> Finance & Invoices
      </button>
      <button class="nav-item" onclick="showPage('clients')">
        <span class="nav-icon">üë•</span> Clients
      </button>
      <button class="nav-item" onclick="showPage('support')">
        <span class="nav-icon">üéß</span> Support
        <span class="nav-badge" id="ticket-badge">...</span>
      </button>
      <button class="nav-item" onclick="showPage('hr')">
        <span class="nav-icon">üë§</span> HR & Staff
      </button>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar">AD</div>
      <div>
        <div class="user-name">Administrator</div>
        <div class="user-role">Boedirep Admin</div>
      </div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <h1 id="page-title">Dashboard</h1>
      <p id="page-date"></p>
    </div>
    <div class="topbar-right">
      <div class="conn-status loading" id="conn-status">
        <div class="conn-dot"></div>
        <span id="conn-text">Connecting...</span>
      </div>
    </div>
  </header>

  <!-- DASHBOARD PAGE -->
  <div class="page active" id="page-dashboard">
    <div id="setup-notice" class="setup-banner" style="display:none">
      <div class="setup-banner-icon">‚öôÔ∏è</div>
      <div class="setup-banner-text">
        <strong>API credentials needed</strong>
        Open this file and replace PASTE_API_KEY_HERE and PASTE_API_SECRET_HERE with your real Frappe API credentials to see live data.
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card green">
        <div class="stat-icon green">üë•</div>
        <div class="stat-label">Total Clients</div>
        <div class="stat-value" id="stat-clients">‚Äî</div>
        <div class="stat-change" id="stat-clients-sub">Loading...</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-icon gold">üí∞</div>
        <div class="stat-label">Total Invoiced</div>
        <div class="stat-value" id="stat-revenue">‚Äî</div>
        <div class="stat-change up" id="stat-revenue-sub">Loading...</div>
      </div>
      <div class="stat-card brown">
        <div class="stat-icon" style="background:rgba(92,74,50,0.08)">üìã</div>
        <div class="stat-label">Unpaid Invoices</div>
        <div class="stat-value" id="stat-unpaid">‚Äî</div>
        <div class="stat-change down" id="stat-unpaid-sub">Loading...</div>
      </div>
      <div class="stat-card red">
        <div class="stat-icon red">üéß</div>
        <div class="stat-label">Open Tickets</div>
        <div class="stat-value" id="stat-tickets">‚Äî</div>
        <div class="stat-change" id="stat-tickets-sub">Loading...</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Recent Invoices</div>
            <div class="card-subtitle">Latest billing activity</div>
          </div>
        </div>
        <div id="dash-invoices"><div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Loading invoices...</div></div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Recent Clients</div>
            <div class="card-subtitle">Latest enrollments</div>
          </div>
        </div>
        <div id="dash-clients"><div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Loading clients...</div></div></div>
      </div>
    </div>
  </div>

  <!-- FINANCE PAGE -->
  <div class="page" id="page-finance">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">All Invoices</div>
          <div class="card-subtitle">Complete billing history from Frappe</div>
        </div>
      </div>
      <div id="finance-content">
        <div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Fetching invoices from Frappe...</div></div>
      </div>
    </div>
  </div>

  <!-- CLIENTS PAGE -->
  <div class="page" id="page-clients">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">All Clients</div>
          <div class="card-subtitle">Everyone enrolled with Boedirep</div>
        </div>
      </div>
      <div id="clients-content">
        <div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Fetching clients from Frappe...</div></div>
      </div>
    </div>
  </div>

  <!-- SUPPORT PAGE -->
  <div class="page" id="page-support">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Support Tickets</div>
          <div class="card-subtitle">All client support requests</div>
        </div>
      </div>
      <div id="support-content">
        <div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Fetching tickets from Frappe...</div></div>
      </div>
    </div>
  </div>

  <!-- HR PAGE -->
  <div class="page" id="page-hr">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Staff & Coaches</div>
          <div class="card-subtitle">All employees and coaches</div>
        </div>
      </div>
      <div id="hr-content">
        <div class="loading-spinner"><div class="spinner"></div><div class="loading-text">Fetching staff from Frappe...</div></div>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================================
// CONFIGURATION ‚Äî Replace with real credentials
// ============================================================
const CONFIG = {
  site_url: "https://boedirep.jh.frappe.cloud",
  api_key: "8efad55bcd23082",
  api_secret: "809abef2d2111d0",
  client_name: "Boedirep",
  currency: "‚Ç¶"
};
// ============================================================

// Check if credentials are set
const credsMissing = CONFIG.api_key === "PASTE_API_KEY_HERE";
if (credsMissing) {
  document.getElementById('setup-notice').style.display = 'flex';
}

// Set date in topbar
const now = new Date();
document.getElementById('page-date').textContent = now.toLocaleDateString('en-NG', {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
});

// ============================================================
// API HELPER
// ============================================================
async function frappeAPI(endpoint, params = {}) {
  const url = new URL(`${CONFIG.site_url}/api/resource/${endpoint}`);
  const defaultParams = {
    limit_page_length: 50,
    ...params
  };
  Object.entries(defaultParams).forEach(([k, v]) => {
    if (typeof v === 'object') {
      url.searchParams.append(k, JSON.stringify(v));
    } else {
      url.searchParams.append(k, v);
    }
  });

  const headers = {
    'Authorization': `token ${CONFIG.api_key}:${CONFIG.api_secret}`,
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  };

  try {
    const response = await fetch(url.toString(), { headers, mode: 'cors' });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    return data.data || [];
  } catch (err) {
    console.error('Frappe API error:', endpoint, err);
    throw err;
  }
}

// ============================================================
// CONNECTION TEST
// ============================================================
async function testConnection() {
  const el = document.getElementById('conn-status');
  const txt = document.getElementById('conn-text');
  if (credsMissing) {
    el.className = 'conn-status disconnected';
    txt.textContent = 'No credentials';
    return false;
  }
  try {
    await frappeAPI('Customer', { limit_page_length: 1 });
    el.className = 'conn-status connected';
    txt.textContent = 'Live ‚Äî Frappe Connected';
    return true;
  } catch {
    el.className = 'conn-status disconnected';
    txt.textContent = 'Connection failed';
    return false;
  }
}

// ============================================================
// FORMAT HELPERS
// ============================================================
function formatMoney(amount) {
  if (!amount) return `${CONFIG.currency}0`;
  return `${CONFIG.currency}${Number(amount).toLocaleString('en-NG', { maximumFractionDigits: 0 })}`;
}

function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  return new Date(dateStr).toLocaleDateString('en-NG', { day: 'numeric', month: 'short', year: 'numeric' });
}

function statusPill(status) {
  const map = {
    'Paid': 'paid', 'Unpaid': 'unpaid', 'Overdue': 'overdue',
    'Draft': 'draft', 'Open': 'open', 'Resolved': 'resolved',
    'Replied': 'replied', 'Active': 'active-emp'
  };
  const cls = map[status] || 'draft';
  return `<span class="pill ${cls}">${status}</span>`;
}

function emptyState(icon, message) {
  return `<div class="empty-state"><div class="empty-icon">${icon}</div>${message}</div>`;
}

function errorState(message) {
  return `<div class="error-box">‚ö†Ô∏è ${message}<br><small>Check your API credentials and CORS settings in Frappe.</small></div>`;
}

// ============================================================
// LOAD DASHBOARD STATS
// ============================================================
async function loadDashboardStats() {
  try {
    // Customers count
    const customers = await frappeAPI('Customer', {
      fields: JSON.stringify(['name']),
      limit_page_length: 500
    });
    document.getElementById('stat-clients').textContent = customers.length;
    document.getElementById('stat-clients-sub').textContent = `Total enrolled clients`;

    // Invoices
    const invoices = await frappeAPI('Sales Invoice', {
      fields: JSON.stringify(['name', 'grand_total', 'status', 'outstanding_amount']),
      limit_page_length: 500
    });
    const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
    const unpaidInvoices = invoices.filter(inv => inv.status === 'Unpaid' || inv.outstanding_amount > 0);
    document.getElementById('stat-revenue').textContent = formatMoney(totalRevenue);
    document.getElementById('stat-revenue-sub').textContent = `From ${invoices.length} invoices`;
    document.getElementById('stat-unpaid').textContent = unpaidInvoices.length;
    document.getElementById('stat-unpaid-sub').textContent = `Awaiting payment`;

    // Tickets
    try {
      const tickets = await frappeAPI('HD Ticket', {
        fields: JSON.stringify(['name', 'status']),
        filters: JSON.stringify([['status', '!=', 'Resolved']]),
        limit_page_length: 100
      });
      document.getElementById('stat-tickets').textContent = tickets.length;
      document.getElementById('stat-tickets-sub').textContent = `Open support tickets`;
      document.getElementById('ticket-badge').textContent = tickets.length;
    } catch {
      document.getElementById('stat-tickets').textContent = '‚Äî';
      document.getElementById('stat-tickets-sub').textContent = 'Helpdesk not configured';
      document.getElementById('ticket-badge').textContent = '0';
    }

  } catch (err) {
    console.error('Stats load error:', err);
  }
}

// ============================================================
// LOAD RECENT INVOICES (Dashboard widget)
// ============================================================
async function loadDashInvoices() {
  const el = document.getElementById('dash-invoices');
  try {
    const invoices = await frappeAPI('Sales Invoice', {
      fields: JSON.stringify(['name', 'customer', 'grand_total', 'status', 'posting_date']),
      limit_page_length: 5,
      order_by: 'posting_date desc'
    });
    if (!invoices.length) {
      el.innerHTML = emptyState('üìÑ', 'No invoices yet. Create your first invoice in Frappe.');
      return;
    }
    el.innerHTML = `<table class="data-table">
      <thead><tr><th>Client</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead>
      <tbody>${invoices.map(inv => `
        <tr>
          <td>${inv.customer || '‚Äî'}</td>
          <td>${formatMoney(inv.grand_total)}</td>
          <td>${formatDate(inv.posting_date)}</td>
          <td>${statusPill(inv.status)}</td>
        </tr>`).join('')}
      </tbody></table>`;
  } catch {
    el.innerHTML = errorState('Could not load invoices');
  }
}

// ============================================================
// LOAD RECENT CLIENTS (Dashboard widget)
// ============================================================
async function loadDashClients() {
  const el = document.getElementById('dash-clients');
  try {
    const customers = await frappeAPI('Customer', {
      fields: JSON.stringify(['name', 'customer_name', 'creation', 'mobile_no']),
      limit_page_length: 5,
      order_by: 'creation desc'
    });
    if (!customers.length) {
      el.innerHTML = emptyState('üë•', 'No clients yet. Add your first client in Frappe.');
      return;
    }
    el.innerHTML = `<table class="data-table">
      <thead><tr><th>Name</th><th>Phone</th><th>Joined</th></tr></thead>
      <tbody>${customers.map(c => `
        <tr>
          <td><strong>${c.customer_name || c.name}</strong></td>
          <td>${c.mobile_no || '‚Äî'}</td>
          <td>${formatDate(c.creation)}</td>
        </tr>`).join('')}
      </tbody></table>`;
  } catch {
    el.innerHTML = errorState('Could not load clients');
  }
}

// ============================================================
// LOAD FULL FINANCE PAGE
// ============================================================
async function loadFinance() {
  const el = document.getElementById('finance-content');
  try {
    const invoices = await frappeAPI('Sales Invoice', {
      fields: JSON.stringify(['name', 'customer', 'grand_total', 'outstanding_amount', 'status', 'posting_date', 'due_date']),
      limit_page_length: 50,
      order_by: 'posting_date desc'
    });
    if (!invoices.length) {
      el.innerHTML = emptyState('üí∞', 'No invoices yet. Create your first invoice inside Frappe to see it here.');
      return;
    }
    const totalInvoiced = invoices.reduce((s, i) => s + (i.grand_total || 0), 0);
    const totalOutstanding = invoices.reduce((s, i) => s + (i.outstanding_amount || 0), 0);
    el.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;padding:1.5rem;border-bottom:1px solid var(--cream2);">
        <div style="text-align:center;">
          <div style="font-size:0.7rem;color:var(--text-faint);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.5rem;">Total Invoiced</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--sage)">${formatMoney(totalInvoiced)}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:0.7rem;color:var(--text-faint);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.5rem;">Outstanding</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--red)">${formatMoney(totalOutstanding)}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:0.7rem;color:var(--text-faint);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.5rem;">Total Invoices</div>
          <div style="font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;">${invoices.length}</div>
        </div>
      </div>
      <table class="data-table">
        <thead><tr><th>Invoice</th><th>Client</th><th>Amount</th><th>Outstanding</th><th>Date</th><th>Due</th><th>Status</th></tr></thead>
        <tbody>${invoices.map(inv => `
          <tr>
            <td style="font-weight:600;color:var(--sage)">${inv.name}</td>
            <td>${inv.customer || '‚Äî'}</td>
            <td>${formatMoney(inv.grand_total)}</td>
            <td style="color:${inv.outstanding_amount > 0 ? 'var(--red)' : 'var(--sage)'}">${formatMoney(inv.outstanding_amount)}</td>
            <td>${formatDate(inv.posting_date)}</td>
            <td>${formatDate(inv.due_date)}</td>
            <td>${statusPill(inv.status)}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch (err) {
    el.innerHTML = errorState('Could not load invoices from Frappe. Check API credentials and CORS settings.');
  }
}

// ============================================================
// LOAD FULL CLIENTS PAGE
// ============================================================
async function loadClients() {
  const el = document.getElementById('clients-content');
  try {
    const customers = await frappeAPI('Customer', {
      fields: JSON.stringify(['name', 'customer_name', 'mobile_no', 'email_id', 'creation', 'customer_group']),
      limit_page_length: 50,
      order_by: 'creation desc'
    });
    if (!customers.length) {
      el.innerHTML = emptyState('üë•', 'No clients yet. Add clients in Frappe under Selling ‚Üí Customer.');
      return;
    }
    el.innerHTML = `
      <table class="data-table">
        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Group</th><th>Joined</th></tr></thead>
        <tbody>${customers.map(c => `
          <tr>
            <td><strong>${c.customer_name || c.name}</strong></td>
            <td style="color:var(--text-dim)">${c.email_id || '‚Äî'}</td>
            <td>${c.mobile_no || '‚Äî'}</td>
            <td>${c.customer_group || '‚Äî'}</td>
            <td>${formatDate(c.creation)}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch {
    el.innerHTML = errorState('Could not load clients from Frappe.');
  }
}

// ============================================================
// LOAD SUPPORT PAGE
// ============================================================
async function loadSupport() {
  const el = document.getElementById('support-content');
  try {
    const tickets = await frappeAPI('HD Ticket', {
      fields: JSON.stringify(['name', 'subject', 'status', 'priority', 'raised_by', 'creation', 'modified']),
      limit_page_length: 50,
      order_by: 'creation desc'
    });
    if (!tickets.length) {
      el.innerHTML = emptyState('üéß', 'No support tickets yet. Tickets from clients will appear here.');
      return;
    }
    el.innerHTML = `
      <table class="data-table">
        <thead><tr><th>Ticket</th><th>Subject</th><th>Raised By</th><th>Priority</th><th>Status</th><th>Date</th></tr></thead>
        <tbody>${tickets.map(t => `
          <tr>
            <td style="font-weight:600;color:var(--sage)">${t.name}</td>
            <td>${t.subject || '‚Äî'}</td>
            <td style="color:var(--text-dim)">${t.raised_by || '‚Äî'}</td>
            <td>${t.priority || '‚Äî'}</td>
            <td>${statusPill(t.status)}</td>
            <td>${formatDate(t.creation)}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch {
    el.innerHTML = emptyState('üéß', 'Helpdesk module not yet configured. Install Frappe Helpdesk and create your first ticket.');
  }
}

// ============================================================
// LOAD HR PAGE
// ============================================================
async function loadHR() {
  const el = document.getElementById('hr-content');
  try {
    const employees = await frappeAPI('Employee', {
      fields: JSON.stringify(['name', 'employee_name', 'designation', 'department', 'date_of_joining', 'status', 'cell_number']),
      limit_page_length: 50,
      order_by: 'date_of_joining desc'
    });
    if (!employees.length) {
      el.innerHTML = emptyState('üë§', 'No staff added yet. Add employees in Frappe under HR ‚Üí Employee.');
      return;
    }
    el.innerHTML = `
      <table class="data-table">
        <thead><tr><th>Name</th><th>Role</th><th>Department</th><th>Phone</th><th>Joined</th><th>Status</th></tr></thead>
        <tbody>${employees.map(e => `
          <tr>
            <td><strong>${e.employee_name || e.name}</strong></td>
            <td>${e.designation || '‚Äî'}</td>
            <td>${e.department || '‚Äî'}</td>
            <td>${e.cell_number || '‚Äî'}</td>
            <td>${formatDate(e.date_of_joining)}</td>
            <td>${statusPill(e.status || 'Active')}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch {
    el.innerHTML = errorState('Could not load staff from Frappe. Make sure Frappe HR is installed.');
  }
}

// ============================================================
// PAGE NAVIGATION
// ============================================================
const pageTitles = {
  dashboard: 'Dashboard',
  finance: 'Finance & Invoices',
  clients: 'Clients',
  support: 'Support Tickets',
  hr: 'HR & Staff'
};

const pageLoaders = {
  finance: loadFinance,
  clients: loadClients,
  support: loadSupport,
  hr: loadHR
};

const loadedPages = new Set();

function showPage(pageId) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  // Show selected
  document.getElementById(`page-${pageId}`).classList.add('active');
  document.querySelector(`[onclick="showPage('${pageId}')"]`).classList.add('active');
  document.getElementById('page-title').textContent = pageTitles[pageId];

  // Load data if not already loaded
  if (pageLoaders[pageId] && !loadedPages.has(pageId)) {
    loadedPages.add(pageId);
    pageLoaders[pageId]();
  }
}

// ============================================================
// INITIALISE
// ============================================================
async function init() {
  const connected = await testConnection();
  if (connected) {
    loadDashboardStats();
    loadDashInvoices();
    loadDashClients();
  } else if (credsMissing) {
    // Show empty states with instructions
    document.getElementById('stat-clients').textContent = '‚Äî';
    document.getElementById('stat-revenue').textContent = '‚Äî';
    document.getElementById('stat-unpaid').textContent = '‚Äî';
    document.getElementById('stat-tickets').textContent = '‚Äî';
    document.getElementById('dash-invoices').innerHTML = emptyState('üîë', 'Add API credentials to see live data');
    document.getElementById('dash-clients').innerHTML = emptyState('üîë', 'Add API credentials to see live data');
  }
}

init();
</script>
</body>
</html>
